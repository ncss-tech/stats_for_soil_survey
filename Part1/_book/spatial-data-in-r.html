<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Spatial Data in R | Statistics for Soil Survey - Part 1</title>
  <meta name="description" content="Web-based course content for Statistics for Soil Survey - Part 1 made with bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Spatial Data in R | Statistics for Soil Survey - Part 1" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Web-based course content for Statistics for Soil Survey - Part 1 made with bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Spatial Data in R | Statistics for Soil Survey - Part 1" />
  
  <meta name="twitter:description" content="Web-based course content for Statistics for Soil Survey - Part 1 made with bookdown::gitbook." />
  

<meta name="author" content="Soil Survey Staff" />


<meta name="date" content="2021-01-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="exploratory-data-analysis.html"/>
<link rel="next" href="sampling.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton-0.0.1/home-button.js"></script>
<script src="libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Statistics for Soil Survey - Part 1</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Pre-course Assignment</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#create-workspace"><i class="fa fa-check"></i><b>0.1</b> Create Workspace</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#configure-rstudio"><i class="fa fa-check"></i><b>0.2</b> Configure RStudio</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#essentials"><i class="fa fa-check"></i><b>0.3</b> Essentials</a></li>
<li class="chapter" data-level="0.4" data-path="index.html"><a href="index.html#personalization"><i class="fa fa-check"></i><b>0.4</b> Personalization</a></li>
<li class="chapter" data-level="0.5" data-path="index.html"><a href="index.html#install-.rprofile"><i class="fa fa-check"></i><b>0.5</b> Install .RProfile</a></li>
<li class="chapter" data-level="0.6" data-path="index.html"><a href="index.html#install-required-packages"><i class="fa fa-check"></i><b>0.6</b> Install Required Packages</a></li>
<li class="chapter" data-level="0.7" data-path="index.html"><a href="index.html#common-errors"><i class="fa fa-check"></i><b>0.7</b> Common Errors</a><ul>
<li class="chapter" data-level="0.7.1" data-path="index.html"><a href="index.html#no-output-is-produced-after-pasting-into-console"><i class="fa fa-check"></i><b>0.7.1</b> No output is produced after pasting into console</a></li>
<li class="chapter" data-level="0.7.2" data-path="index.html"><a href="index.html#somepackage-is-not-available-for-r-version-x.y.z"><i class="fa fa-check"></i><b>0.7.2</b> <code>‘SOMEPACKAGE’ is not available (for R version X.Y.Z)</code></a></li>
</ul></li>
<li class="chapter" data-level="0.8" data-path="index.html"><a href="index.html#packages-not-on-cran"><i class="fa fa-check"></i><b>0.8</b> Packages not on CRAN</a></li>
<li class="chapter" data-level="0.9" data-path="index.html"><a href="index.html#connect-local-nasis"><i class="fa fa-check"></i><b>0.9</b> Connect Local NASIS</a></li>
<li class="chapter" data-level="0.10" data-path="index.html"><a href="index.html#proof"><i class="fa fa-check"></i><b>0.10</b> Proof</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction to R and RStudio</a><ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#outline"><i class="fa fa-check"></i><b>1.1</b> Outline</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#course-overview"><i class="fa fa-check"></i><b>1.2</b> Course Overview</a><ul>
<li class="chapter" data-level="1.2.1" data-path="intro.html"><a href="intro.html#course-objectives"><i class="fa fa-check"></i><b>1.2.1</b> Course Objectives</a></li>
<li class="chapter" data-level="1.2.2" data-path="intro.html"><a href="intro.html#why-is-this-training-needed"><i class="fa fa-check"></i><b>1.2.2</b> Why is this training needed?</a></li>
<li class="chapter" data-level="1.2.3" data-path="intro.html"><a href="intro.html#why-is-course-organized-this-way"><i class="fa fa-check"></i><b>1.2.3</b> Why is course organized this way?</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#what-is-r"><i class="fa fa-check"></i><b>1.3</b> What is R?</a><ul>
<li class="chapter" data-level="1.3.1" data-path="intro.html"><a href="intro.html#why-should-i-learn-r"><i class="fa fa-check"></i><b>1.3.1</b> Why Should I Learn R?</a></li>
<li class="chapter" data-level="1.3.2" data-path="intro.html"><a href="intro.html#what-can-r-do"><i class="fa fa-check"></i><b>1.3.2</b> What can R do?</a></li>
<li class="chapter" data-level="1.3.3" data-path="intro.html"><a href="intro.html#packages"><i class="fa fa-check"></i><b>1.3.3</b> Packages</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#rstudio-an-integrated-development-environment-ide-for-r"><i class="fa fa-check"></i><b>1.4</b> RStudio: An Integrated Development Environment (IDE) for R</a><ul>
<li class="chapter" data-level="1.4.1" data-path="intro.html"><a href="intro.html#usda-computer-setup"><i class="fa fa-check"></i><b>1.4.1</b> USDA Computer Setup</a></li>
<li class="chapter" data-level="1.4.2" data-path="intro.html"><a href="intro.html#basic-tips-for-using-r"><i class="fa fa-check"></i><b>1.4.2</b> Basic Tips for using R</a></li>
<li class="chapter" data-level="1.4.3" data-path="intro.html"><a href="intro.html#working-directories"><i class="fa fa-check"></i><b>1.4.3</b> Working Directories</a></li>
<li class="chapter" data-level="1.4.4" data-path="intro.html"><a href="intro.html#data-management-in-rstudio"><i class="fa fa-check"></i><b>1.4.4</b> Data Management in RStudio</a></li>
<li class="chapter" data-level="1.4.5" data-path="intro.html"><a href="intro.html#getting-help"><i class="fa fa-check"></i><b>1.4.5</b> Getting Help</a></li>
<li class="chapter" data-level="1.4.6" data-path="intro.html"><a href="intro.html#packages-1"><i class="fa fa-check"></i><b>1.4.6</b> Packages</a></li>
<li class="chapter" data-level="1.4.7" data-path="intro.html"><a href="intro.html#writing-scripts"><i class="fa fa-check"></i><b>1.4.7</b> Writing Scripts</a></li>
<li class="chapter" data-level="1.4.8" data-path="intro.html"><a href="intro.html#saving-r-files"><i class="fa fa-check"></i><b>1.4.8</b> Saving R Files</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="intro.html"><a href="intro.html#review"><i class="fa fa-check"></i><b>1.5</b> Review</a></li>
<li class="chapter" data-level="1.6" data-path="intro.html"><a href="intro.html#additional-reading-introduction"><i class="fa fa-check"></i><b>1.6</b> Additional Reading (Introduction)</a></li>
<li class="chapter" data-level="1.7" data-path="intro.html"><a href="intro.html#references-introduction"><i class="fa fa-check"></i><b>1.7</b> References (Introduction)</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="the-data-we-use.html"><a href="the-data-we-use.html"><i class="fa fa-check"></i><b>2</b> The Data We Use</a><ul>
<li class="chapter" data-level="2.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#objectives-data"><i class="fa fa-check"></i><b>2.1</b> Objectives (Data)</a></li>
<li class="chapter" data-level="2.2" data-path="the-data-we-use.html"><a href="the-data-we-use.html#the-structure-of-our-data"><i class="fa fa-check"></i><b>2.2</b> The Structure of Our Data</a><ul>
<li class="chapter" data-level="2.2.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#package-references"><i class="fa fa-check"></i><b>2.2.1</b> Package References</a></li>
<li class="chapter" data-level="2.2.2" data-path="the-data-we-use.html"><a href="the-data-we-use.html#soildb-functions"><i class="fa fa-check"></i><b>2.2.2</b> soilDB Functions</a></li>
<li class="chapter" data-level="2.2.3" data-path="the-data-we-use.html"><a href="the-data-we-use.html#importance-of-pedon-data"><i class="fa fa-check"></i><b>2.2.3</b> Importance of Pedon Data</a></li>
<li class="chapter" data-level="2.2.4" data-path="the-data-we-use.html"><a href="the-data-we-use.html#some-issues-with-pedon-data"><i class="fa fa-check"></i><b>2.2.4</b> Some Issues With Pedon Data</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="the-data-we-use.html"><a href="the-data-we-use.html#challenges-with-pedon-data"><i class="fa fa-check"></i><b>2.3</b> Challenges with Pedon Data</a><ul>
<li class="chapter" data-level="2.3.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#meeting-the-challenges"><i class="fa fa-check"></i><b>2.3.1</b> Meeting the Challenges</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="the-data-we-use.html"><a href="the-data-we-use.html#the-aqp-soilprofilecollection"><i class="fa fa-check"></i><b>2.4</b> The <code>aqp</code> <code>SoilProfileCollection</code></a><ul>
<li class="chapter" data-level="2.4.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#soilprofilecollection-methods"><i class="fa fa-check"></i><b>2.4.1</b> SoilProfileCollection methods</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="the-data-we-use.html"><a href="the-data-we-use.html#using-the-soildb-package"><i class="fa fa-check"></i><b>2.5</b> Using the soilDB Package</a><ul>
<li class="chapter" data-level="2.5.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#fetchnasis"><i class="fa fa-check"></i><b>2.5.1</b> <code>fetchNASIS()</code></a></li>
<li class="chapter" data-level="2.5.2" data-path="the-data-we-use.html"><a href="the-data-we-use.html#open-database-connectivity-odbc-connection-to-nasis"><i class="fa fa-check"></i><b>2.5.2</b> Open Database Connectivity (ODBC) Connection to NASIS</a></li>
<li class="chapter" data-level="2.5.3" data-path="the-data-we-use.html"><a href="the-data-we-use.html#the-gopheridge-soildb-dataset"><i class="fa fa-check"></i><b>2.5.3</b> The <code>gopheridge</code> <code>soilDB</code> Dataset</a></li>
<li class="chapter" data-level="2.5.4" data-path="the-data-we-use.html"><a href="the-data-we-use.html#prepare-example-data"><i class="fa fa-check"></i><b>2.5.4</b> Prepare Example Data</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="the-data-we-use.html"><a href="the-data-we-use.html#viewing-pedon-locations"><i class="fa fa-check"></i><b>2.6</b> Viewing Pedon Locations</a><ul>
<li class="chapter" data-level="2.6.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#plotting-geographic-data"><i class="fa fa-check"></i><b>2.6.1</b> Plotting Geographic Data</a></li>
<li class="chapter" data-level="2.6.2" data-path="the-data-we-use.html"><a href="the-data-we-use.html#displaying-pedon-data-in-google-earth"><i class="fa fa-check"></i><b>2.6.2</b> Displaying Pedon Data in Google Earth</a></li>
<li class="chapter" data-level="2.6.3" data-path="the-data-we-use.html"><a href="the-data-we-use.html#exporting-pedon-data-to-an-esri-shapefile"><i class="fa fa-check"></i><b>2.6.3</b> Exporting Pedon Data to an ESRI Shapefile</a></li>
<li class="chapter" data-level="2.6.4" data-path="the-data-we-use.html"><a href="the-data-we-use.html#follow-along-with-your-own-data-1"><i class="fa fa-check"></i><b>2.6.4</b> Follow along with your own data</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="the-data-we-use.html"><a href="the-data-we-use.html#working-with-data-in-r"><i class="fa fa-check"></i><b>2.7</b> Working with Data in R</a><ul>
<li class="chapter" data-level="2.7.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#summaries"><i class="fa fa-check"></i><b>2.7.1</b> Summaries</a></li>
<li class="chapter" data-level="2.7.2" data-path="the-data-we-use.html"><a href="the-data-we-use.html#missing-values"><i class="fa fa-check"></i><b>2.7.2</b> Missing Values</a></li>
<li class="chapter" data-level="2.7.3" data-path="the-data-we-use.html"><a href="the-data-we-use.html#logical-operators"><i class="fa fa-check"></i><b>2.7.3</b> Logical Operators</a></li>
<li class="chapter" data-level="2.7.4" data-path="the-data-we-use.html"><a href="the-data-we-use.html#pattern-matching"><i class="fa fa-check"></i><b>2.7.4</b> Pattern Matching</a></li>
<li class="chapter" data-level="2.7.5" data-path="the-data-we-use.html"><a href="the-data-we-use.html#filtering"><i class="fa fa-check"></i><b>2.7.5</b> Filtering</a></li>
<li class="chapter" data-level="2.7.6" data-path="the-data-we-use.html"><a href="the-data-we-use.html#filtering-data-by-logical-criteria-with-aqpsubset"><i class="fa fa-check"></i><b>2.7.6</b> Filtering Data by Logical Criteria with <code>aqp::subset</code></a></li>
<li class="chapter" data-level="2.7.7" data-path="the-data-we-use.html"><a href="the-data-we-use.html#dates-and-times"><i class="fa fa-check"></i><b>2.7.7</b> Dates and Times</a></li>
<li class="chapter" data-level="2.7.8" data-path="the-data-we-use.html"><a href="the-data-we-use.html#review-of-data-checks-run-by-fetchnasis"><i class="fa fa-check"></i><b>2.7.8</b> Review of Data Checks Run by <code>fetchNASIS()</code></a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="the-data-we-use.html"><a href="the-data-we-use.html#extended-data-functions"><i class="fa fa-check"></i><b>2.8</b> Extended Data Functions</a><ul>
<li class="chapter" data-level="2.8.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#thicknesses-of-diagnostic-features"><i class="fa fa-check"></i><b>2.8.1</b> Thicknesses of Diagnostic Features</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="the-data-we-use.html"><a href="the-data-we-use.html#soil-reports"><i class="fa fa-check"></i><b>2.9</b> Soil Reports</a><ul>
<li class="chapter" data-level="2.9.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#requirements"><i class="fa fa-check"></i><b>2.9.1</b> Requirements</a></li>
<li class="chapter" data-level="2.9.2" data-path="the-data-we-use.html"><a href="the-data-we-use.html#instructions"><i class="fa fa-check"></i><b>2.9.2</b> Instructions</a></li>
<li class="chapter" data-level="2.9.3" data-path="the-data-we-use.html"><a href="the-data-we-use.html#exercise-run-the-region11lab_summary_by_taxonname"><i class="fa fa-check"></i><b>2.9.3</b> Exercise: run the region11/lab_summary_by_taxonname</a></li>
<li class="chapter" data-level="2.9.4" data-path="the-data-we-use.html"><a href="the-data-we-use.html#exercise-run-mapunit-comparison"><i class="fa fa-check"></i><b>2.9.4</b> Exercise: Run Mapunit Comparison</a></li>
<li class="chapter" data-level="2.9.5" data-path="the-data-we-use.html"><a href="the-data-we-use.html#exercise-run-shiny-pedon-summary"><i class="fa fa-check"></i><b>2.9.5</b> Exercise: Run Shiny Pedon Summary</a></li>
</ul></li>
<li class="chapter" data-level="2.10" data-path="the-data-we-use.html"><a href="the-data-we-use.html#customized-queries-to-local-nasis-database"><i class="fa fa-check"></i><b>2.10</b> Customized Queries to Local NASIS Database</a><ul>
<li class="chapter" data-level="2.10.1" data-path="the-data-we-use.html"><a href="the-data-we-use.html#rodbc-package"><i class="fa fa-check"></i><b>2.10.1</b> <code>RODBC</code> package</a></li>
<li class="chapter" data-level="2.10.2" data-path="the-data-we-use.html"><a href="the-data-we-use.html#dbi"><i class="fa fa-check"></i><b>2.10.2</b> <code>DBI</code></a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html"><i class="fa fa-check"></i><b>3</b> Exploratory Data Analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#objectives-exploratory-data-analysis"><i class="fa fa-check"></i><b>3.1</b> Objectives (Exploratory Data Analysis)</a></li>
<li class="chapter" data-level="3.2" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#statistics"><i class="fa fa-check"></i><b>3.2</b> Statistics</a></li>
<li class="chapter" data-level="3.3" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#data-inspection"><i class="fa fa-check"></i><b>3.3</b> Data Inspection</a><ul>
<li class="chapter" data-level="3.3.1" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#exercise-fetch-and-inspect"><i class="fa fa-check"></i><b>3.3.1</b> Exercise: fetch and inspect</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#descriptive-statistics"><i class="fa fa-check"></i><b>3.4</b> Descriptive Statistics</a><ul>
<li class="chapter" data-level="3.4.1" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#measures-of-central-tendency"><i class="fa fa-check"></i><b>3.4.1</b> Measures of Central Tendency</a></li>
<li class="chapter" data-level="3.4.2" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#measures-of-dispersion"><i class="fa fa-check"></i><b>3.4.2</b> Measures of Dispersion</a></li>
<li class="chapter" data-level="3.4.3" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#correlation"><i class="fa fa-check"></i><b>3.4.3</b> Correlation</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#graphical-methods"><i class="fa fa-check"></i><b>3.5</b> Graphical Methods</a><ul>
<li class="chapter" data-level="3.5.1" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#distributions"><i class="fa fa-check"></i><b>3.5.1</b> Distributions</a></li>
<li class="chapter" data-level="3.5.2" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#bar-plot"><i class="fa fa-check"></i><b>3.5.2</b> Bar Plot</a></li>
<li class="chapter" data-level="3.5.3" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#histogram"><i class="fa fa-check"></i><b>3.5.3</b> Histogram</a></li>
<li class="chapter" data-level="3.5.4" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#density-curve"><i class="fa fa-check"></i><b>3.5.4</b> Density Curve</a></li>
<li class="chapter" data-level="3.5.5" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#box-plots"><i class="fa fa-check"></i><b>3.5.5</b> Box plots</a></li>
<li class="chapter" data-level="3.5.6" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#quantile-comparison-plots-qqplot"><i class="fa fa-check"></i><b>3.5.6</b> Quantile comparison plots (QQplot)</a></li>
<li class="chapter" data-level="3.5.7" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#the-normal-distribution"><i class="fa fa-check"></i><b>3.5.7</b> The ‘Normal’ distribution</a></li>
<li class="chapter" data-level="3.5.8" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#scatterplots-and-line-plots"><i class="fa fa-check"></i><b>3.5.8</b> Scatterplots and Line Plots</a></li>
<li class="chapter" data-level="3.5.9" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#rd-dimension---color-shape-size-layers-etc"><i class="fa fa-check"></i><b>3.5.9</b> 3rd Dimension - Color, Shape, Size, Layers, etc…</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#transformations"><i class="fa fa-check"></i><b>3.6</b> Transformations</a><ul>
<li class="chapter" data-level="3.6.1" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#ph"><i class="fa fa-check"></i><b>3.6.1</b> pH</a></li>
<li class="chapter" data-level="3.6.2" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#circular-data"><i class="fa fa-check"></i><b>3.6.2</b> Circular data</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#references-exploratory-data-analysis"><i class="fa fa-check"></i><b>3.7</b> References (Exploratory Data Analysis)</a></li>
<li class="chapter" data-level="3.8" data-path="exploratory-data-analysis.html"><a href="exploratory-data-analysis.html#additional-reading-exploratory-data-analysis"><i class="fa fa-check"></i><b>3.8</b> Additional Reading (Exploratory Data Analysis)</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html"><i class="fa fa-check"></i><b>4</b> Spatial Data in R</a><ul>
<li class="chapter" data-level="4.1" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#objectives-spatial-data-structures"><i class="fa fa-check"></i><b>4.1</b> Objectives (Spatial Data Structures)</a></li>
<li class="chapter" data-level="4.2" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#making-maps-with-r"><i class="fa fa-check"></i><b>4.2</b> Making Maps with R</a></li>
<li class="chapter" data-level="4.3" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#spatial-data-sources"><i class="fa fa-check"></i><b>4.3</b> Spatial Data Sources</a></li>
<li class="chapter" data-level="4.4" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#many-packages-many-spatial-representations"><i class="fa fa-check"></i><b>4.4</b> Many Packages, Many Spatial Representations</a><ul>
<li class="chapter" data-level="4.4.1" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#the-sf-package"><i class="fa fa-check"></i><b>4.4.1</b> The <code>sf</code> package</a></li>
<li class="chapter" data-level="4.4.2" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#the-sp-package"><i class="fa fa-check"></i><b>4.4.2</b> The <code>sp</code> Package</a></li>
<li class="chapter" data-level="4.4.3" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#converting-sp-and-sf"><i class="fa fa-check"></i><b>4.4.3</b> Converting <code>sp</code> and <code>sf</code></a></li>
<li class="chapter" data-level="4.4.4" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#importing-exporting-vector-data"><i class="fa fa-check"></i><b>4.4.4</b> Importing / Exporting Vector Data</a></li>
<li class="chapter" data-level="4.4.5" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#interactive-mapping-with-mapview-and-leaflet"><i class="fa fa-check"></i><b>4.4.5</b> Interactive mapping with <code>mapview</code> and <code>leaflet</code></a></li>
<li class="chapter" data-level="4.4.6" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#the-raster-package"><i class="fa fa-check"></i><b>4.4.6</b> The <code>raster</code> Package</a></li>
<li class="chapter" data-level="4.4.7" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#converting-vector-to-raster"><i class="fa fa-check"></i><b>4.4.7</b> Converting Vector to Raster</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#coordinate-reference-systems"><i class="fa fa-check"></i><b>4.5</b> Coordinate Reference Systems</a><ul>
<li class="chapter" data-level="4.5.1" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#assigning-and-transforming-coordinate-systems"><i class="fa fa-check"></i><b>4.5.1</b> Assigning and Transforming Coordinate Systems</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#operations-on-example-data"><i class="fa fa-check"></i><b>4.6</b> Operations on Example Data</a><ul>
<li class="chapter" data-level="4.6.1" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#load-required-packages"><i class="fa fa-check"></i><b>4.6.1</b> Load Required Packages</a></li>
<li class="chapter" data-level="4.6.2" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#download-example-data"><i class="fa fa-check"></i><b>4.6.2</b> Download Example Data</a></li>
<li class="chapter" data-level="4.6.3" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#load-the-data"><i class="fa fa-check"></i><b>4.6.3</b> Load the Data</a></li>
<li class="chapter" data-level="4.6.4" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#spatial-overlay-operations"><i class="fa fa-check"></i><b>4.6.4</b> Spatial Overlay Operations</a></li>
<li class="chapter" data-level="4.6.5" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#sampling-and-extraction"><i class="fa fa-check"></i><b>4.6.5</b> Sampling and Extraction</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="spatial-data-in-r.html"><a href="spatial-data-in-r.html#additional-reading-spatial"><i class="fa fa-check"></i><b>4.7</b> Additional Reading (Spatial)</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sampling.html"><a href="sampling.html"><i class="fa fa-check"></i><b>5</b> Sampling</a><ul>
<li class="chapter" data-level="5.1" data-path="sampling.html"><a href="sampling.html#introduction"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="sampling.html"><a href="sampling.html#sampling-strategies"><i class="fa fa-check"></i><b>5.2</b> Sampling Strategies</a><ul>
<li class="chapter" data-level="5.2.1" data-path="sampling.html"><a href="sampling.html#simple-random"><i class="fa fa-check"></i><b>5.2.1</b> Simple Random</a></li>
<li class="chapter" data-level="5.2.2" data-path="sampling.html"><a href="sampling.html#stratified-random"><i class="fa fa-check"></i><b>5.2.2</b> Stratified Random</a></li>
<li class="chapter" data-level="5.2.3" data-path="sampling.html"><a href="sampling.html#multistage-stratified-random"><i class="fa fa-check"></i><b>5.2.3</b> Multistage Stratified Random</a></li>
<li class="chapter" data-level="5.2.4" data-path="sampling.html"><a href="sampling.html#systematic"><i class="fa fa-check"></i><b>5.2.4</b> Systematic</a></li>
<li class="chapter" data-level="5.2.5" data-path="sampling.html"><a href="sampling.html#cluster"><i class="fa fa-check"></i><b>5.2.5</b> Cluster</a></li>
<li class="chapter" data-level="5.2.6" data-path="sampling.html"><a href="sampling.html#conditioned-latin-hypercube-clhs"><i class="fa fa-check"></i><b>5.2.6</b> Conditioned Latin Hypercube (cLHS)</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="sampling.html"><a href="sampling.html#evaluating-a-sampling-strategy"><i class="fa fa-check"></i><b>5.3</b> Evaluating a Sampling Strategy</a><ul>
<li class="chapter" data-level="5.3.1" data-path="sampling.html"><a href="sampling.html#exercise-design-a-sampling-strategy"><i class="fa fa-check"></i><b>5.3.1</b> Exercise: Design a Sampling Strategy</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="sampling.html"><a href="sampling.html#other-tools-for-selecting-random-features"><i class="fa fa-check"></i><b>5.4</b> Other Tools for Selecting Random Features</a><ul>
<li class="chapter" data-level="5.4.1" data-path="sampling.html"><a href="sampling.html#clhs-using-teui"><i class="fa fa-check"></i><b>5.4.1</b> cLHS Using TEUI</a></li>
<li class="chapter" data-level="5.4.2" data-path="sampling.html"><a href="sampling.html#two-stage-stratified-random-sample-design-using-arcgis"><i class="fa fa-check"></i><b>5.4.2</b> Two-Stage Stratified Random Sample Design Using ArcGIS</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="sampling.html"><a href="sampling.html#references-sampling"><i class="fa fa-check"></i><b>5.5</b> References (Sampling)</a></li>
<li class="chapter" data-level="5.6" data-path="sampling.html"><a href="sampling.html#additional-reading-sampling"><i class="fa fa-check"></i><b>5.6</b> Additional Reading (Sampling)</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Statistics for Soil Survey - Part 1</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-data-in-r" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Spatial Data in R</h1>
<p><img src="static-figures/logo.jpg" /></p>
<p>Most of us are familiar with spatial data types, sources, and the jargon used to describe interaction with these data.</p>
<p>GIS software provides a convenient framework for most of the spatial analysis that we do, however, the combination of statistical routines, advanced graphics, and data access functionality make <em>R</em> an ideal environment for soil science.</p>
<p>For example, with a couple of lines of <em>R</em> code, it is possible to quickly integrate soil morphology (NASIS), lab data (KSSL), map unit polygons (SSURGO), and climate data (PRISM raster files).</p>
<p>This chapter is a very brief demonstration of several possible ways to process spatial data in R.</p>
<!--

These are a bit dated references. Let's not overwhelm too much with redirection at beginning of the chapter.-AGB

A more thorough treatment can be found in [*Applied Spatial Data Analysis with R*](http://www.asdar-book.org/) or [*Spatial Data Analysis and Modeling with R*](http://rspatial.org/spatial/). 

The [*Spatial Cheatsheet*](http://www.maths.lancs.ac.uk/~rowlings/Teaching/UseR2012/cheatsheet.html) is a convenient summary of the most commonly used functions. The [*Drawing beautiful maps programatically*](https://www.r-spatial.org/r/2018/10/25/ggplot2-sf.html) tutorial is an excellent primer on making maps in R.
-->
<div id="objectives-spatial-data-structures" class="section level2">
<h2><span class="header-section-number">4.1</span> Objectives (Spatial Data Structures)</h2>
<ul>
<li>Gain experience with creating, editing, and exporting spatial data objects in R.</li>
<li>Learn about tools for making maps with R</li>
<li>Learn the basics of <code>sf</code> and <code>sp</code> representation of vector data</li>
<li>Learn the basics of <code>raster</code> classes and functions</li>
<li>Learn about some interfaces to NCSS spatial data sources</li>
<li>Develop a strategy for navigating the many possible spatial data processing methods</li>
</ul>
<p>There are <a href="https://cran.r-project.org/web/views/Spatial.html">many packages</a> available for working with spatial data, however we only have time to cover the below libraries.</p>
<p>The next couple of sections will require loading these libraries into the R session.</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="spatial-data-in-r.html#cb215-1"></a><span class="kw">library</span>(aqp)</span>
<span id="cb215-2"><a href="spatial-data-in-r.html#cb215-2"></a><span class="kw">library</span>(soilDB)</span>
<span id="cb215-3"><a href="spatial-data-in-r.html#cb215-3"></a></span>
<span id="cb215-4"><a href="spatial-data-in-r.html#cb215-4"></a><span class="kw">library</span>(sf)</span>
<span id="cb215-5"><a href="spatial-data-in-r.html#cb215-5"></a></span>
<span id="cb215-6"><a href="spatial-data-in-r.html#cb215-6"></a><span class="kw">library</span>(sp)</span>
<span id="cb215-7"><a href="spatial-data-in-r.html#cb215-7"></a><span class="kw">library</span>(rgdal)</span>
<span id="cb215-8"><a href="spatial-data-in-r.html#cb215-8"></a></span>
<span id="cb215-9"><a href="spatial-data-in-r.html#cb215-9"></a><span class="kw">library</span>(raster)</span></code></pre></div>
</div>
<div id="making-maps-with-r" class="section level2">
<h2><span class="header-section-number">4.2</span> Making Maps with R</h2>
<p>R has become a powerful tool for visualization and interaction with spatial data. There are many tools available for making maps with R! It is not all geostatistics and coordinate reference system transformations … there are powerful ways to automate your GIS work flow from beginning to end – from creating terrain derivatives from a source DEM, all the way to high-quality, publication-ready maps and interactive HTML/JavaScript widgets.</p>
<p>All of the details of this could fill several books! And it does! A great resource that provides some comparisons of the major tools for this purpose is <a href="https://bookdown.org/nicohahn/making_maps_with_r5/docs/introduction.html">Making Maps with R</a>.</p>
<p><em>Making Maps with R</em> shows similar processes using 5 different packages that have different focuses and applications: <code>tmap</code>, <code>ggplot2</code>, <code>mapview</code>, <code>mapdeck</code> and <code>leaflet</code></p>
</div>
<div id="spatial-data-sources" class="section level2">
<h2><span class="header-section-number">4.3</span> Spatial Data Sources</h2>
<p>Conventional spatial data sources:</p>
<ul>
<li>raster data sources (elevation, PRISM, etc.): GeoTIFF, ERDAS, BIL, ASCII grid, WMS, …</li>
<li>vector data sources (points/lines/polygons): Shape File, “file” geodatabase, KML, GeoJSON, GML, WFS, …</li>
</ul>
<p>Conventional data sources that can be <em>upgraded</em> to spatial data:</p>
<ul>
<li>NASIS/LIMS reports: typically site coordinates</li>
<li>web pages: <a href="http://geojson.org/">GeoJSON</a>, <a href="https://en.wikipedia.org/wiki/Well-known_text">WKT</a>, or point coordinates</li>
<li>Excel file: typically point coordinates</li>
<li>CSV files: typically point coordinates</li>
</ul>
<p>R-based interfaces to NCSS data sources via <a href="https://cran.r-project.org/web/packages/soilDB/index.html"><code>soilDB</code></a> package:</p>
<ul>
<li><p>functions that return tabular data which can be <em>upgraded</em> to spatial data:</p>
<ul>
<li><a href="http://ncss-tech.github.io/AQP/soilDB/KSSL-demo.html"><code>fetchKSSL()</code></a>: KSSL “site” data contain x,y coordinates</li>
</ul></li>
<li><p><a href="http://ncss-tech.github.io/AQP/soilDB/fetchNASIS-mini-tutorial.html"><code>fetchNASIS()</code></a>: NASIS “site” data contain x,y, coordinates</p></li>
<li><p><a href="http://ncss-tech.github.io/AQP/soilDB/RaCA-demo.html"><code>fetchRaCA()</code></a>: RaCA central pedon x,y coordinates</p></li>
<li><p>functions that return spatial data:</p>
<ul>
<li><a href="http://ncss-tech.github.io/AQP/soilDB/series-extent.html"><code>seriesExtent()</code></a>: simplified series extent as polygons</li>
</ul></li>
<li><p><a href="http://ncss-tech.github.io/AQP/soilDB/Henry-demo.html"><code>fetchHenry()</code></a>: sensor / weather station locations as points</p></li>
<li><p><a href="http://ncss-tech.github.io/AQP/soilDB/SDA-tutorial-2.html"><code>SDA_query()</code></a>: SSURGO data as points, lines, polygons (via SDA)</p></li>
<li><p><code>mapunit_geom_by_ll_bbox()</code>: SSURGO data as polygons (via WFS)</p></li>
</ul>
<p><strong>NOTE:</strong> <strike>currently, there is no way to read raster data from ESRI “file” geodatabases.</strike> except for this: <a href="https://github.com/r-barnes/ArcRasterRescue" class="uri">https://github.com/r-barnes/ArcRasterRescue</a>, which requires ability to compile C code with <code>CMAKE</code> (non-government computer). Vector data (and associated attribute tables) can be accessed.</p>
</div>
<div id="many-packages-many-spatial-representations" class="section level2">
<h2><span class="header-section-number">4.4</span> Many Packages, Many Spatial Representations</h2>
<div id="the-sf-package" class="section level3">
<h3><span class="header-section-number">4.4.1</span> The <code>sf</code> package</h3>
<p><a href="https://www.ogc.org/standards/sfa">Simple Features Access</a> is a set of standards that specify a common storage and access model of geographic features. It is used mostly for two-dimensional geometries such as point, line, polygon, multi-point, multi-line, etc.</p>
<p>This is one of many ways of modeling the geometry of shapes in the real world. This model happens to be widely adopted in the <strong>R</strong> ecosystem via the <code>sf</code> package, and very convenient for typical data encountered by soil survey operations.</p>
<p>The <a href="https://r-spatial.github.io/sf/">sf package</a> represents the latest and greatest in spatial data processing within the comfort of an R session. It provides a “main” object class <code>sf</code> to contain geometric data and associated tabular data in a familiar <code>data.frame</code> format. <code>sf</code> methods work on a variety of different levels of abstraction and manipulation of those geometries.</p>
<div id="sf-vignettes" class="section level4">
<h4><span class="header-section-number">4.4.1.1</span> <code>sf</code> vignettes</h4>
<ol style="list-style-type: decimal">
<li><p><a href="https://r-spatial.github.io/sf/articles/sf1.html">Simple Features for R</a></p></li>
<li><p><a href="https://r-spatial.github.io/sf/articles/sf2.html">Reading, Writing and Converting Simple Features</a></p></li>
<li><p><a href="https://r-spatial.github.io/sf/articles/sf3.html">Manipulating Simple Feature Geometries</a></p></li>
<li><p><a href="https://r-spatial.github.io/sf/articles/sf4.html">Manipulating Simple Features</a></p></li>
<li><p><a href="https://r-spatial.github.io/sf/articles/sf5.html">Plotting Simple Features</a></p></li>
<li><p><a href="https://r-spatial.github.io/sf/articles/sf6.html">Miscellaneous</a></p></li>
<li><p><a href="https://r-spatial.github.io/sf/articles/sf7.html">Spherical geometry in sf using s2geometry</a></p></li>
</ol>
</div>
</div>
<div id="the-sp-package" class="section level3">
<h3><span class="header-section-number">4.4.2</span> The <code>sp</code> Package</h3>
<p>The data structures (“classes”) and functions provided by the <a href="https://cran.r-project.org/web/packages/sp/index.html"><code>sp</code></a> package have served a foundational role in the handling of spatial data in R for years.</p>
<p>Many of the following examples will reference names such as <code>SpatialPoints</code>, <code>SpatialPointsDataFrame</code>, and <code>SpatialPolygonsDataFrame</code>. These are specialized (S4) classes, implemented by the <code>sp</code> package.</p>
<p>Objects of these classes maintain linkages between all of the components of spatial data. For example, a point, line, or polygon feature will typically be associated with:</p>
<ul>
<li>coordinate geometry</li>
<li>bounding box</li>
<li>coordinate reference system</li>
<li>attribute table</li>
</ul>
</div>
<div id="converting-sp-and-sf" class="section level3">
<h3><span class="header-section-number">4.4.3</span> Converting <code>sp</code> and <code>sf</code></h3>
<p><code>sp</code> provides access to the same compiled code libraries (PROJ, GDAL, GEOS) as <code>sf</code>, but mostly via the interfaces in the separate <code>rgdal</code> package.</p>
<p>For certain applications, such as some packages we demonstrate below, there are no <code>sp</code> “interfaces” to the methods – only <code>sf</code>, or vice-versa.</p>
<p>The two different categories of object types are interchangeable, and you may find yourself having to do this for a variety of reasons. You can convert between objects using <code>sf::as_Spatial</code> or <code>sf::st_as_sf</code>.</p>
<p>Check the documentation (<code>?functionname</code>) to figure out what object types different methods need as input; and check an input object’s class with <code>class()</code> or <code>inherits()</code>.</p>
</div>
<div id="importing-exporting-vector-data" class="section level3">
<h3><span class="header-section-number">4.4.4</span> Importing / Exporting Vector Data</h3>
<p>Import a feature class from a ESRI File Geodatabase or shape file.</p>
<p>If you have a <em>.shp</em> file, you can specify the whole path, including the file extension in the <code>dsn</code> argument, or just the folder. For a Geodatabase, you should specify the feature class using the <code>layer</code> argument. Note that a trailing “/” is omitted from the <code>dsn</code> (data source name) and the “.shp” suffix is omitted from the <code>layer</code>.</p>
<div id="sf" class="section level4">
<h4><span class="header-section-number">4.4.4.1</span> <code>sf</code></h4>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="spatial-data-in-r.html#cb216-1"></a>x &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_read</span>(<span class="dt">dsn =</span> <span class="st">&#39;E:/gis_data/ca630/FG_CA630_OFFICIAL.gdb&#39;</span>, <span class="dt">layer =</span> <span class="st">&#39;ca630_a&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="spatial-data-in-r.html#cb217-1"></a>sf<span class="op">::</span><span class="kw">write_sf</span>(x, <span class="dt">dsn =</span> <span class="st">&#39;E:/gis_data/ca630/pedon_locations.shp&#39;</span>)</span></code></pre></div>
</div>
<div id="sp-rgdal" class="section level4">
<h4><span class="header-section-number">4.4.4.2</span> <code>sp</code> / <code>rgdal</code></h4>
<p>Export object <code>x</code> to shapefile.</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="spatial-data-in-r.html#cb218-1"></a>x &lt;-<span class="st"> </span>rgdal<span class="op">::</span><span class="kw">readOGR</span>(<span class="dt">dsn =</span> <span class="st">&#39;E:/gis_data/ca630/FG_CA630_OFFICIAL.gdb&#39;</span>, <span class="dt">layer =</span> <span class="st">&#39;ca630_a&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="spatial-data-in-r.html#cb219-1"></a>rgdal<span class="op">::</span><span class="kw">writeOGR</span>(x, <span class="dt">dsn =</span> <span class="st">&#39;E:/gis_data/ca630/pedon_locations.shp&#39;</span>, <span class="dt">driver =</span> <span class="st">&#39;ESRI Shapefile&#39;</span>)</span></code></pre></div>
<p>The <code>st_read()</code> / <code>read_sf()</code> / <code>write_sf()</code> and <code>readOGR()</code>, <code>writeOGR()</code>, <code>readGDAL()</code>, <code>writeGDAL()</code> functions have many arguments, so it is worth spending some time with the associated manual pages.
If you have a <em>.shp</em> file, you can specify the whole path, including the file extension in the <code>dsn</code> argument.</p>
</div>
</div>
<div id="interactive-mapping-with-mapview-and-leaflet" class="section level3">
<h3><span class="header-section-number">4.4.5</span> Interactive mapping with <code>mapview</code> and <code>leaflet</code></h3>
<p>These packages make it possible to display interactive maps of <code>sf</code> objects in RStudio, or within an HTML document generated via R Markdown (e.g. this document).</p>
<ul>
<li><a href="https://github.com/r-spatial/mapview"><code>mapview</code> package</a></li>
<li><a href="https://rstudio.github.io/leaflet/"><code>leaflet</code> package</a></li>
<li><a href="https://cran.r-project.org/web/packages/leafem/index.html"><code>leafem</code>: ‘leaflet’ Extensions for ‘mapview’</a></li>
</ul>
<p>The <code>seriesExtent</code> method in soilDB returns results as an <code>sp</code> object showing generalized extent polygons for a soil series.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="spatial-data-in-r.html#cb220-1"></a><span class="co"># load required packages</span></span>
<span id="cb220-2"><a href="spatial-data-in-r.html#cb220-2"></a><span class="kw">library</span>(sf)</span>
<span id="cb220-3"><a href="spatial-data-in-r.html#cb220-3"></a><span class="kw">library</span>(mapview)</span>
<span id="cb220-4"><a href="spatial-data-in-r.html#cb220-4"></a><span class="kw">library</span>(leafem)</span>
<span id="cb220-5"><a href="spatial-data-in-r.html#cb220-5"></a><span class="kw">library</span>(leafpop)</span>
<span id="cb220-6"><a href="spatial-data-in-r.html#cb220-6"></a></span>
<span id="cb220-7"><a href="spatial-data-in-r.html#cb220-7"></a><span class="co"># get series extents from SoilWeb</span></span>
<span id="cb220-8"><a href="spatial-data-in-r.html#cb220-8"></a>pentz &lt;-<span class="st"> </span><span class="kw">seriesExtent</span>(<span class="st">&#39;pentz&#39;</span>)</span>
<span id="cb220-9"><a href="spatial-data-in-r.html#cb220-9"></a>redding &lt;-<span class="st"> </span><span class="kw">seriesExtent</span>(<span class="st">&#39;redding&#39;</span>)</span>
<span id="cb220-10"><a href="spatial-data-in-r.html#cb220-10"></a></span>
<span id="cb220-11"><a href="spatial-data-in-r.html#cb220-11"></a><span class="co"># make a simple map</span></span>
<span id="cb220-12"><a href="spatial-data-in-r.html#cb220-12"></a>m &lt;-<span class="st"> </span><span class="kw">mapview</span>(<span class="kw">st_as_sf</span>(pentz))</span>
<span id="cb220-13"><a href="spatial-data-in-r.html#cb220-13"></a></span>
<span id="cb220-14"><a href="spatial-data-in-r.html#cb220-14"></a><span class="co"># add more data to the map and display</span></span>
<span id="cb220-15"><a href="spatial-data-in-r.html#cb220-15"></a><span class="kw">addFeatures</span>(m, <span class="kw">st_as_sf</span>(redding), <span class="dt">color=</span><span class="st">&#39;black&#39;</span>, <span class="dt">fillColor=</span><span class="st">&#39;red&#39;</span>, <span class="dt">weight=</span><span class="dv">1</span>)</span></code></pre></div>
</div>
<div id="the-raster-package" class="section level3">
<h3><span class="header-section-number">4.4.6</span> The <code>raster</code> Package</h3>
<p>The <a href="https://cran.r-project.org/web/packages/raster/index.html"><code>raster</code> package</a> package provides most of the commonly used grid processing functionality that one might find in a conventional GIS:</p>
<ul>
<li>re-sampling / interpolation</li>
<li>warping (coordinate system transformations of gridded data)</li>
<li>cropping, mosaicing, masking</li>
<li>local and focal functions</li>
<li>raster algebra</li>
<li>contouring</li>
<li>raster/vector conversions</li>
<li>terrain analysis</li>
<li>model-based prediction (more on this in later chapters)</li>
</ul>
<p><a href="https://cran.r-project.org/web/packages/raster/vignettes/Raster.pdf"><em>Introduction to the raster package</em></a> vignette</p>
<!--
##### `terra`
  
A more complete background on the capabilities of the `raster` package, and the replacement [`terra`](https://rspatial.org/terra/index.html) are described in the and [*Spatial Data Science with R*](http://rspatial.org/) online book. 

##### `stars`

There is also a package called [`stars`](https://r-spatial.github.io/stars/) (Spatiotemporal Arrays: Raster and Vector Datacubes) that seeks to deal with similar raster data problems, with a specific focus on higher-dimensional "data cubes" where time, spectral band, sensor form dimensions of the data.
-->
<div id="importing-exporting-rasters" class="section level4">
<h4><span class="header-section-number">4.4.6.1</span> Importing / Exporting Rasters</h4>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="spatial-data-in-r.html#cb221-1"></a><span class="co"># use an example from the raster package</span></span>
<span id="cb221-2"><a href="spatial-data-in-r.html#cb221-2"></a>f &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;external/test.grd&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;raster&quot;</span>)</span>
<span id="cb221-3"><a href="spatial-data-in-r.html#cb221-3"></a></span>
<span id="cb221-4"><a href="spatial-data-in-r.html#cb221-4"></a><span class="co"># create a reference to this raster</span></span>
<span id="cb221-5"><a href="spatial-data-in-r.html#cb221-5"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(f)</span>
<span id="cb221-6"><a href="spatial-data-in-r.html#cb221-6"></a></span>
<span id="cb221-7"><a href="spatial-data-in-r.html#cb221-7"></a><span class="co"># print the details</span></span>
<span id="cb221-8"><a href="spatial-data-in-r.html#cb221-8"></a><span class="kw">print</span>(r)</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## dimensions : 115, 80, 9200  (nrow, ncol, ncell)
## resolution : 40, 40  (x, y)
## extent     : 178400, 181600, 329400, 334000  (xmin, xmax, ymin, ymax)
## crs        : +proj=sterea +lat_0=52.1561605555556 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +datum=WGS84 +units=m +no_defs 
## source     : C:/Users/Andrew.G.Brown/Documents/R/win-library/4.0/raster/external/test.grd 
## names      : test 
## values     : 138.7071, 1736.058  (min, max)</code></pre>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="spatial-data-in-r.html#cb223-1"></a><span class="co"># default plot method</span></span>
<span id="cb223-2"><a href="spatial-data-in-r.html#cb223-2"></a><span class="kw">plot</span>(r)</span></code></pre></div>
<p><img src="newbook_files/figure-html/unnamed-chunk-109-1.png" width="576" /></p>
<p>The disk-based reference can be converted to an in-memory <code>RasterLayer</code> with the <code>readAll()</code> function.</p>
<p>Processing of raster data in memory is always faster than processing on disk, as long as there is sufficient memory.</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="spatial-data-in-r.html#cb224-1"></a><span class="co"># check: file is on disk</span></span>
<span id="cb224-2"><a href="spatial-data-in-r.html#cb224-2"></a><span class="kw">inMemory</span>(r)</span>
<span id="cb224-3"><a href="spatial-data-in-r.html#cb224-3"></a></span>
<span id="cb224-4"><a href="spatial-data-in-r.html#cb224-4"></a><span class="co"># load into memory, if possible</span></span>
<span id="cb224-5"><a href="spatial-data-in-r.html#cb224-5"></a>r &lt;-<span class="st"> </span><span class="kw">readAll</span>(r)</span>
<span id="cb224-6"><a href="spatial-data-in-r.html#cb224-6"></a></span>
<span id="cb224-7"><a href="spatial-data-in-r.html#cb224-7"></a><span class="co"># check: file is in memory</span></span>
<span id="cb224-8"><a href="spatial-data-in-r.html#cb224-8"></a><span class="kw">inMemory</span>(r)</span></code></pre></div>
<p>Exporting data requires consideration of the output format, datatype, encoding of NODATA, and other options such as compression.</p>
<p>See the manual pages for <code>writeRaster()</code>, <code>writeFormats()</code>, and <code>dataType()</code> for details. For example, suppose you had a <code>RasterLayer</code> object that you wanted to save to disk as an internally-compressed GeoTIFF:</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="spatial-data-in-r.html#cb225-1"></a><span class="co"># using previous example data set</span></span>
<span id="cb225-2"><a href="spatial-data-in-r.html#cb225-2"></a><span class="kw">writeRaster</span>(r, <span class="dt">filename=</span><span class="st">&#39;r.tif&#39;</span>, <span class="dt">options =</span> <span class="kw">c</span>(<span class="st">&quot;COMPRESS=LZW&quot;</span>))</span></code></pre></div>
<p>The <code>writeRaster()</code> function interprets the given (and missing) arguments as:</p>
<ul>
<li>‘.tif’ suffix interpreted as <code>format=GTiff</code></li>
<li>creation options of “LZW compression” passed to GeoTiff driver</li>
<li>default <code>datatype</code></li>
<li>default <code>NAflag</code></li>
</ul>
</div>
<div id="object-properties" class="section level4">
<h4><span class="header-section-number">4.4.6.2</span> Object Properties</h4>
<p><code>RasterLayer</code> objects are similar to <code>sf</code> and <code>sp</code> objects in that they keep track of the linkages between data, coordinate reference system, and optional attribute tables. Getting and setting the contents of <code>RasterLayer</code> objects should be performed using functions such as:</p>
<ul>
<li><code>NAvalue(r)</code>: get / set the NODATA value</li>
<li><code>crs(r)</code> or <code>proj4string(r)</code>: get / set the coordinate reference system</li>
<li><code>res(r)</code>: get / set the resolution</li>
<li><code>extent(r)</code>: get / set the extent</li>
<li><code>dataType(r)</code>: get / set the data type</li>
<li>… many more, see the <code>raster</code> package manual</li>
</ul>
</div>
</div>
<div id="converting-vector-to-raster" class="section level3">
<h3><span class="header-section-number">4.4.7</span> Converting Vector to Raster</h3>
<div id="rasterrasterize" class="section level4">
<h4><span class="header-section-number">4.4.7.1</span> <code>raster::rasterize()</code></h4>
</div>
<div id="fasterizefasterize" class="section level4">
<h4><span class="header-section-number">4.4.7.2</span> <code>fasterize::fasterize()</code></h4>
</div>
</div>
</div>
<div id="coordinate-reference-systems" class="section level2">
<h2><span class="header-section-number">4.5</span> Coordinate Reference Systems</h2>
<p>Spatial data aren’t all that useful without an accurate description of the coordinate reference system (CRS). This type of information is typically stored within the “.prj” component of a shapefile, or in the header of a GeoTIFF.
Without a CRS it is not possible to perform coordinate transformations (e.g. conversion of geographic coordinates to projected coordinates), spatial overlay (e.g. intersection), or geometric calculations (e.g. distance or area).</p>
<p>The “old” way (PROJ.4) of specifying coordinate reference systems is using character strings containing, for example: <code>+proj</code> or <code>+init</code> arguments. In general, this still “works,” so you may encounter it and need to know about it. But you also may encounter cases where CRS are specified using integer EPSG codes, OGC codes or well-known text (WKT).</p>
<p>Some common examples of coordinate system EPSG codes and their legacy PROJ.4 strings:</p>
<ul>
<li><em>EPSG</em>: <code>4269</code> / <em>PROJ.4</em>:<code>+proj=longlat +datum=NAD83</code> - geographic, NAD83 datum</li>
<li><em>EPSG</em>: <code>4267</code> / <em>PROJ.4</em>:<code>+proj=longlat +datum=NAD27</code> - geographic, NAD27 datum</li>
<li><em>EPSG</em>: <code>26910</code> / <em>PROJ.4</em>:<code>+proj=utm +zone=10 +datum=NAD83</code> - projected (UTM zone 10), NAD83 datum</li>
<li><em>EPSG</em>: <code>6350</code> / <em>PROJ.4</em>: <code>+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23.0 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs</code> - Albers Equal Area CONUS (Used for gSSURGO)</li>
</ul>
<p>While you may encounter PROJ.4 strings, these are no longer considered the preferred method of referencing Coordinate Reference Systems – and, in general, newer methods are “easier.”</p>
<p>Well-known text (WKT) is a human- machine-readable standard format for geometry, so storing the Coordinate Reference System information in a similar format makes sense. This format is returned by the <code>sf::st_crs</code> method.</p>
<p>For example: the WKT representation of <code>EPSG:4326</code>:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="spatial-data-in-r.html#cb226-1"></a><span class="kw">st_crs</span>(<span class="dv">4326</span>)</span></code></pre></div>
<pre><code>## Coordinate Reference System:
##   User input: EPSG:4326 
##   wkt:
## GEOGCRS[&quot;WGS 84&quot;,
##     DATUM[&quot;World Geodetic System 1984&quot;,
##         ELLIPSOID[&quot;WGS 84&quot;,6378137,298.257223563,
##             LENGTHUNIT[&quot;metre&quot;,1]]],
##     PRIMEM[&quot;Greenwich&quot;,0,
##         ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##     CS[ellipsoidal,2],
##         AXIS[&quot;geodetic latitude (Lat)&quot;,north,
##             ORDER[1],
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##         AXIS[&quot;geodetic longitude (Lon)&quot;,east,
##             ORDER[2],
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##     USAGE[
##         SCOPE[&quot;unknown&quot;],
##         AREA[&quot;World&quot;],
##         BBOX[-90,-180,90,180]],
##     ID[&quot;EPSG&quot;,4326]]</code></pre>
<p>This is using the <a href="https://www.ogc.org/standards/wkt-crs">OGC WKT CRS standard</a>. Adoption of this standard caused some significant changes in packages in the R ecosystem.</p>
<p>So you can get familiar, what follows are several examples of doing the same thing: setting the CRS of spatial objects with WGS84 longitude/latitude geographic coordinates. If you have another target coordinate system, it is just a matter of using the correct codes to identify it.</p>
<div id="assigning-and-transforming-coordinate-systems" class="section level3">
<h3><span class="header-section-number">4.5.1</span> Assigning and Transforming Coordinate Systems</h3>
<p>Returning to the example from above, lets <strong>assign</strong> a CRS to our series extent <code>s</code> using different methods.</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="spatial-data-in-r.html#cb228-1"></a>s &lt;-<span class="st"> </span><span class="kw">seriesExtent</span>(<span class="st">&#39;san joaquin&#39;</span>)</span></code></pre></div>
<p>The following are equivalent <code>sf</code> versus <code>sp</code>/<code>rgdal</code> syntax.</p>
<div id="sf-1" class="section level4">
<h4><span class="header-section-number">4.5.1.1</span> <code>sf</code></h4>
<p>Use <code>st_crs&lt;-</code>/<code>st_crs</code> to set or get CRS of <code>sf</code> objects. Supply the target EPSG code as an integer.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="spatial-data-in-r.html#cb229-1"></a><span class="co"># s is an sp object, we convert it to sf with st_as_sf</span></span>
<span id="cb229-2"><a href="spatial-data-in-r.html#cb229-2"></a>s &lt;-<span class="st"> </span><span class="kw">st_as_sf</span>(s) </span>
<span id="cb229-3"><a href="spatial-data-in-r.html#cb229-3"></a></span>
<span id="cb229-4"><a href="spatial-data-in-r.html#cb229-4"></a><span class="kw">st_crs</span>(s) &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_crs</span>(<span class="dv">4326</span>)</span></code></pre></div>
<p>Transformation of points, lines, and polygons with <code>sf</code> requires an “origin” CRS be defined in the object that is the argument <code>x</code>, and “target” CRS defined in <code>crs</code> argument as an integer, or output of <code>st_crs()</code>.</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="spatial-data-in-r.html#cb230-1"></a><span class="co"># transform to UTM zone 10</span></span>
<span id="cb230-2"><a href="spatial-data-in-r.html#cb230-2"></a>s.utm &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="dt">x =</span> s, <span class="dt">crs =</span> <span class="dv">26910</span>)</span>
<span id="cb230-3"><a href="spatial-data-in-r.html#cb230-3"></a></span>
<span id="cb230-4"><a href="spatial-data-in-r.html#cb230-4"></a><span class="co"># transform to GCS NAD27</span></span>
<span id="cb230-5"><a href="spatial-data-in-r.html#cb230-5"></a>s.nad27 &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="dt">x =</span> s, <span class="dt">crs =</span> <span class="kw">st_crs</span>(<span class="dv">4267</span>))</span></code></pre></div>
</div>
<div id="sp-rgdal-1" class="section level4">
<h4><span class="header-section-number">4.5.1.2</span> <code>sp</code> / <code>rgdal</code></h4>
<p>You can do the same thing several different ways with <code>sp</code> objects. An equivalent EPSG, OGC and PROJ.4 can be set or get using <code>proj4string&lt;-</code>/<code>proj4string</code> and either a <code>sp</code> <code>CRS</code> object or a PROJ.4 string for <code>Spatial</code> objects.</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="spatial-data-in-r.html#cb231-1"></a><span class="co"># s is an sf object (we converted it), convert back to Spatial* object</span></span>
<span id="cb231-2"><a href="spatial-data-in-r.html#cb231-2"></a>s &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">as_Spatial</span>(s) </span>
<span id="cb231-3"><a href="spatial-data-in-r.html#cb231-3"></a></span>
<span id="cb231-4"><a href="spatial-data-in-r.html#cb231-4"></a><span class="co"># these all create the same internal sp::CRS object</span></span>
<span id="cb231-5"><a href="spatial-data-in-r.html#cb231-5"></a><span class="kw">proj4string</span>(s) &lt;-<span class="st"> </span>sp<span class="op">::</span><span class="kw">CRS</span>(<span class="st">&#39;EPSG:4326&#39;</span>)          <span class="co"># proj &gt;6; EPSG</span></span>
<span id="cb231-6"><a href="spatial-data-in-r.html#cb231-6"></a><span class="kw">proj4string</span>(s) &lt;-<span class="st"> </span>sp<span class="op">::</span><span class="kw">CRS</span>(<span class="st">&#39;OGC:CRS84&#39;</span>)          <span class="co"># proj &gt;6; OGC</span></span>
<span id="cb231-7"><a href="spatial-data-in-r.html#cb231-7"></a><span class="kw">proj4string</span>(s) &lt;-<span class="st"> &#39;+init=epsg:4326&#39;</span>             <span class="co"># proj4 style +init string</span></span>
<span id="cb231-8"><a href="spatial-data-in-r.html#cb231-8"></a><span class="kw">proj4string</span>(s) &lt;-<span class="st"> &#39;+proj=longlat +datum=WGS84&#39;</span>  <span class="co"># proj4 style +proj string</span></span></code></pre></div>
<p>Here, we do the same transformations we did above only using <code>sp</code>: <code>spTransform()</code>.</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="spatial-data-in-r.html#cb232-1"></a><span class="co"># transform to UTM zone 10</span></span>
<span id="cb232-2"><a href="spatial-data-in-r.html#cb232-2"></a>s.utm &lt;-<span class="st"> </span><span class="kw">spTransform</span>(s, <span class="kw">CRS</span>(<span class="st">&#39;+proj=utm +zone=10 +datum=NAD83&#39;</span>))</span>
<span id="cb232-3"><a href="spatial-data-in-r.html#cb232-3"></a></span>
<span id="cb232-4"><a href="spatial-data-in-r.html#cb232-4"></a><span class="co"># transform to GCS NAD27</span></span>
<span id="cb232-5"><a href="spatial-data-in-r.html#cb232-5"></a>s.nad27 &lt;-<span class="st"> </span><span class="kw">spTransform</span>(s, <span class="kw">CRS</span>(<span class="st">&#39;+proj=longlat +datum=NAD27&#39;</span>))</span></code></pre></div>
</div>
<div id="raster" class="section level4">
<h4><span class="header-section-number">4.5.1.3</span> <code>raster</code></h4>
<p>Use <code>crs&lt;-</code>/<code>crs</code> for <code>raster</code> or <code>Spatial</code> objects, it takes as argument and returns a <code>sp</code> <code>CRS</code> object.</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="spatial-data-in-r.html#cb233-1"></a><span class="co"># r is a raster object; set CRS as the CRS of itself</span></span>
<span id="cb233-2"><a href="spatial-data-in-r.html#cb233-2"></a><span class="kw">crs</span>(r) &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw">crs</span>(sp<span class="op">::</span><span class="kw">CRS</span>(r))</span></code></pre></div>
<p>“Transforming” or warping a raster is a different matter than a vector as it requires interpolation of pixels to a defined target resolution and CRS.</p>
<p>The method provided by <code>raster</code> to do this is <code>projectRaster()</code>. It works the same as the above transform methods in that you specify an object to transform, and the target reference system or a template for the object.</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="spatial-data-in-r.html#cb234-1"></a>r.wgs84 &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(r, <span class="kw">CRS</span>(<span class="st">&quot;EPSG:4326&quot;</span>))</span></code></pre></div>
<p>Note that the default <code>projectRaster</code> uses <em>bilinear interpolation</em> (<code>method='bilinear'</code>), which is appropriate for continuous variables. You also have the option of using nearest-neighbor (<code>method='ngb'</code>) for categorical variables (class maps) where interpolation does not make sense.</p>
<p>If we want to save this transformed raster to file, we can use something like this:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="spatial-data-in-r.html#cb235-1"></a><span class="kw">writeRaster</span>(r, <span class="dt">filename=</span><span class="st">&#39;r.tif&#39;</span>, <span class="dt">options=</span><span class="kw">c</span>(<span class="st">&quot;COMPRESS=LZW&quot;</span>))</span></code></pre></div>
</div>
<div id="related-links" class="section level4">
<h4><span class="header-section-number">4.5.1.4</span> Related Links</h4>
<ul>
<li><a href="https://r-spatial.github.io/sf/"><code>sf</code> package website</a></li>
<li><a href="https://rspatial.org/">rspatial.org - Spatial Data Science with R</a></li>
<li><a href="https://inbo.github.io/tutorials/tutorials/spatial_crs_coding/">Goodbye PROJ.4 strings! How to specify a coordinate reference system in R?</a></li>
<li><a href="http://benbestphd.com/R-adv-spatial-lessons/">R Advanced Spatial Lessons by Ben Best</a></li>
<li><a href="http://pierreroudier.github.io/teaching/20171014-DSM-Masterclass-Hamilton/spatial-data-in-R.html">Spatial Data in R by Pierre Roudier</a></li>
</ul>
<!--
While it is possible to hand-make `sp` class objects, it is usually faster to import existing raster or vector files from disk. More on this later. For the sake of demonstration we will make a `SpatialPointsDataFrame` object. This is analogous to the point type feature class or shapefile.


```r
# create point geometry from coordinates
p <- SpatialPoints(coords = cbind(-97.721210, 40.446068))
# attach attribute table
p <- SpatialPointsDataFrame(p, data=data.frame(id=1, taxonname='alpha'))
# check internal structure
str(p)
```

This is an "S4" object with "slots" (e.g. `@data`) that are used to store various components. Most all S4 objects have specialized functions for getting and setting the contents of the slots. For example, the `bbox()` function is used to get or set the contents of the `@bbox` slot.

There is a convenient shortcut for "upgrading" point data that is stored in a `data.frame`. This is especially useful for preparing NASIS/KSSL data for spatial operations.


```r
# make some fake data
d <- data.frame(x=runif(10), y=runif(10), id=1:10, code=letters[1:10])
# upgrade to SpatialPointsDataFrame
coordinates(d) <- ~ x + y
# check
class(d)
```

See the [sp gallery](https://edzer.github.io/sp/) and [this vignette](https://cran.r-project.org/web/packages/sp/vignettes/intro_sp.pdf) for a much more detailed description of the `sp` classes.

#### Interacting with `sp` Objects

`sp` objects are modeled after `data.frame` objects; rows (features) and columns (attributes) are accessed using `[]` or `$` notation.

Extract the first 5 features (and all associated attributes) from a `SpatialPointsDataFrame` object:

```r
# [rows, columns]
# [features, attributes]
d[1:5, ]
```

Extract the attributed called `id`:

```r
d$id
```

Create some random numbers and save to a new attribute called `rand`:

```r
# new data must be of the same length as number of features, otherwise recycling will occur
d$rand <- rnorm(n=nrow(d))
```

Filter features based on attributes:

```r
idx <- which(d$rand > 0)
d[idx, ]
```

Convert back to a `data.frame` object:

```r
as(d, 'data.frame')
```

#### Coordinate Reference Systems and `proj4` Syntax

Spatial data aren't all that useful without an accurate description of the coordinate reference system (CRS). This type of information is typically stored within the ".prj" component of a shapefile, or in the header of a GeoTiff. Without a CRS it is not possible to perform coordinate transformations (e.g. conversion of geographic coordinates to projected coordinates), spatial overlay (e.g. intersection), or geometric calculations (e.g. distance or area).

In R, CRS information is encoded using ["proj4" notation](http://proj4.org/), which looks something like this: `'+proj=longlat +datum=WGS84'` (geographic coordinates referenced to the WGS84 datum). You can look-up CRS definitions in many different formats on the [spatialreference.org](http://spatialreference.org/) website. Some examples:
  
  * `+proj=longlat +datum=NAD83`: geographic coordinate system, NAD83 datum
* `+proj=longlat +datum=NAD27`: geographic coordinate system, NAD27 datum
* `+proj=utm +zone=10 +datum=NAD83`: projected coordinate system (UTM zone 10), NAD83 datum
* `+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23.0 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs`: AEA CONUS / gSSURGO

Returning to the example from above, lets **assign** a CRS to this point using the `proj4string()` function. Note that this process doesn't alter the geometry of the object.

```r
proj4string(p) <- '+proj=longlat +datum=WGS84' 
str(p)
```

Transformation of points, lines, and polygons is a simple matter--as long the source and destination CRS data are available.

```r
# transform to UTM zone 14
p.utm <- spTransform(p, CRS('+proj=utm +zone=14 +datum=NAD83'))
cbind(gcs=coordinates(p), utm=coordinates(p.utm))

# transform to GCS NAD27
p.nad27 <- spTransform(p, CRS('+proj=longlat +datum=NAD27'))
cbind(coordinates(p), coordinates(p.nad27))
```

CRS definitions can also be generated from [EPSG](http://epsg.io/) codes. For example, a geographic coordinate system referenced to the WGS84 datum can be accessed using EPSG code 4326:

```r
CRS('+init=epsg:4326')
```

### Accessing Spatial Data Sources via GDAL/OGR

Many of the vector data sources we use can be directly translated to `sp` class objects via `rgdal` package. The `rgdal` package provides linkages to the powerful [GDAL/OGR](http://www.gdal.org/) library, the details of which are well beyond the scope of this training. Suffice to say, `rgdal` makes it possible to import just about any vector or raster data using two basic functions:

 * `readOGR()`: vector data sources such as shape files, KML, etc.
 * `readGDAL()`: raster data sources such as GeoTiff, IMG, ArcGRID, ASCII grids, etc.
 
A full listing of available drivers can be accessed with `ogrDrivers()` and `gdalDrivers()`. Note that it is not yet possible to load raster data from an ESRI File Geodatabase.

This module will not cover importing or exporting raster data via `rgdal` as the `raster` package provides a much more convenient interface to the GDAL library.
-->
<!--
##### Data Types

It is worth spending a couple minutes going over some the commonly used `datatypes`; "unsigned integer", " signed integer", and "floating point" of variable precision.

 * `INT1U`: integers from 0 to 255
 * `INT2U`: integers from 0 to 65,534
 * `INT2S`: integers from -32,767 to 32,767
 * `INT4S`: integers from -2,147,483,647 to 2,147,483,647
 * `FLT4S`: floating point from -3.4e+38 to 3.4e+38
 * `FLT8S`: floating point from -1.7e+308 to 1.7e+308

It is wise to manually specify an output `datatype` that will "just fit" the required precision. For example, if you have generated a `RasterLayer` that warrants integer precision and ranges from 0 to 100, then the `INT1U` data type would provide enough precision to store all possible values *and* the NODATA value. Raster data stored as integers will always be smaller (sometimes 10-100x) than floating point, especially when internal compression is enabled.

##### Notes on Compression

In general, it is always a good idea to create internally-compressed raster data. The [GeoTiff format](https://gdal.org/drivers/raster/gtiff.html) can accomodate many different compression algorithms, including lossy (JPEG) compression. See [this article](https://kokoalberti.com/articles/geotiff-compression-optimization-guide/) for some ideas on optimization of file read/write times and associated compressed file sizes. Usually, the default "LZW" or "DEFLATE" compression will result in significant savings, especially for data encoded as integers.

```r
# reasonable compression
writeRaster(r, filename='r.tif', options=c("COMPRESS=LZW"))

# takes longer to write the file, but better compression
writeRaster(r, filename='r.tif', options=c("COMPRESS=DEFLATE", "PREDICTOR=2", "ZLEVEL=9"))
```
-->
</div>
</div>
</div>
<div id="operations-on-example-data" class="section level2">
<h2><span class="header-section-number">4.6</span> Operations on Example Data</h2>
<div id="load-required-packages" class="section level3">
<h3><span class="header-section-number">4.6.1</span> Load Required Packages</h3>
<p>Load required packages into the current R Session.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="spatial-data-in-r.html#cb236-1"></a><span class="kw">library</span>(aqp)</span>
<span id="cb236-2"><a href="spatial-data-in-r.html#cb236-2"></a><span class="kw">library</span>(soilDB)</span>
<span id="cb236-3"><a href="spatial-data-in-r.html#cb236-3"></a></span>
<span id="cb236-4"><a href="spatial-data-in-r.html#cb236-4"></a><span class="kw">library</span>(sp)</span>
<span id="cb236-5"><a href="spatial-data-in-r.html#cb236-5"></a><span class="kw">library</span>(rgdal)</span>
<span id="cb236-6"><a href="spatial-data-in-r.html#cb236-6"></a></span>
<span id="cb236-7"><a href="spatial-data-in-r.html#cb236-7"></a><span class="kw">library</span>(raster)</span></code></pre></div>
</div>
<div id="download-example-data" class="section level3">
<h3><span class="header-section-number">4.6.2</span> Download Example Data</h3>
<p>This code will create a path for this example data in the <code>workspace2</code> folder you created. It will download a set of polygons and rasters.</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="spatial-data-in-r.html#cb237-1"></a><span class="co"># store path as a variable, in case you want to keep it somewhere else</span></span>
<span id="cb237-2"><a href="spatial-data-in-r.html#cb237-2"></a>ch2b.data.path &lt;-<span class="st"> &#39;C:/workspace2/chapter-2b&#39;</span></span>
<span id="cb237-3"><a href="spatial-data-in-r.html#cb237-3"></a></span>
<span id="cb237-4"><a href="spatial-data-in-r.html#cb237-4"></a><span class="co"># make a place to store chapter 2b example data</span></span>
<span id="cb237-5"><a href="spatial-data-in-r.html#cb237-5"></a><span class="kw">dir.create</span>(ch2b.data.path, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)</span>
<span id="cb237-6"><a href="spatial-data-in-r.html#cb237-6"></a></span>
<span id="cb237-7"><a href="spatial-data-in-r.html#cb237-7"></a><span class="co"># download polygon example data from github</span></span>
<span id="cb237-8"><a href="spatial-data-in-r.html#cb237-8"></a><span class="kw">download.file</span>(<span class="st">&#39;https://github.com/ncss-tech/stats_for_soil_survey/raw/master/data/chapter_2b-spatial-data/chapter-2b-mu-polygons.zip&#39;</span>, <span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;chapter-2b-mu-polygons.zip&#39;</span>))</span>
<span id="cb237-9"><a href="spatial-data-in-r.html#cb237-9"></a></span>
<span id="cb237-10"><a href="spatial-data-in-r.html#cb237-10"></a><span class="co"># download raster example data from github </span></span>
<span id="cb237-11"><a href="spatial-data-in-r.html#cb237-11"></a><span class="kw">download.file</span>(<span class="st">&#39;https://github.com/ncss-tech/stats_for_soil_survey/raw/master/data/chapter_2b-spatial-data/chapter-2b-PRISM.zip&#39;</span>, <span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;chapter-2b-PRISM.zip&#39;</span>))</span>
<span id="cb237-12"><a href="spatial-data-in-r.html#cb237-12"></a></span>
<span id="cb237-13"><a href="spatial-data-in-r.html#cb237-13"></a><span class="co"># unzip</span></span>
<span id="cb237-14"><a href="spatial-data-in-r.html#cb237-14"></a><span class="kw">unzip</span>(<span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;chapter-2b-mu-polygons.zip&#39;</span>), <span class="dt">exdir =</span> ch2b.data.path, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</span>
<span id="cb237-15"><a href="spatial-data-in-r.html#cb237-15"></a></span>
<span id="cb237-16"><a href="spatial-data-in-r.html#cb237-16"></a><span class="kw">unzip</span>(<span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;chapter-2b-PRISM.zip&#39;</span>), <span class="dt">exdir =</span> ch2b.data.path, <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
</div>
<div id="load-the-data" class="section level3">
<h3><span class="header-section-number">4.6.3</span> Load the Data</h3>
<p>We will be using polygons associated with MLRAs 15 and 18 as part of this demonstration.</p>
<p>Import these data now with <code>readOGR()</code>; recall the somewhat strange syntax. You will need the data and <code>RasterStack</code> object <code>rs</code> we created in the examples above.</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="spatial-data-in-r.html#cb238-1"></a><span class="co"># set path to example data</span></span>
<span id="cb238-2"><a href="spatial-data-in-r.html#cb238-2"></a>ch2b.data.path &lt;-<span class="st"> &#39;C:/workspace2/chapter-2b&#39;</span></span>
<span id="cb238-3"><a href="spatial-data-in-r.html#cb238-3"></a></span>
<span id="cb238-4"><a href="spatial-data-in-r.html#cb238-4"></a><span class="co"># load MLRA polygons</span></span>
<span id="cb238-5"><a href="spatial-data-in-r.html#cb238-5"></a>mlra &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn =</span> ch2b.data.path, <span class="dt">layer =</span> <span class="st">&#39;mlra-18-15-AEA&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="spatial-data-in-r.html#cb239-1"></a><span class="co"># mean annual air temperature, Deg C</span></span>
<span id="cb239-2"><a href="spatial-data-in-r.html#cb239-2"></a>maat &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;MAAT.tif&#39;</span>))</span>
<span id="cb239-3"><a href="spatial-data-in-r.html#cb239-3"></a></span>
<span id="cb239-4"><a href="spatial-data-in-r.html#cb239-4"></a><span class="co"># mean annual precipitation, mm</span></span>
<span id="cb239-5"><a href="spatial-data-in-r.html#cb239-5"></a>map &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;MAP.tif&#39;</span>))</span>
<span id="cb239-6"><a href="spatial-data-in-r.html#cb239-6"></a></span>
<span id="cb239-7"><a href="spatial-data-in-r.html#cb239-7"></a><span class="co"># frost-free days</span></span>
<span id="cb239-8"><a href="spatial-data-in-r.html#cb239-8"></a>ffd &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;FFD.tif&#39;</span>))</span>
<span id="cb239-9"><a href="spatial-data-in-r.html#cb239-9"></a></span>
<span id="cb239-10"><a href="spatial-data-in-r.html#cb239-10"></a><span class="co"># growing degree days</span></span>
<span id="cb239-11"><a href="spatial-data-in-r.html#cb239-11"></a>gdd &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;GDD.tif&#39;</span>))</span>
<span id="cb239-12"><a href="spatial-data-in-r.html#cb239-12"></a></span>
<span id="cb239-13"><a href="spatial-data-in-r.html#cb239-13"></a><span class="co"># percent of annual PPT as rain</span></span>
<span id="cb239-14"><a href="spatial-data-in-r.html#cb239-14"></a>rain_fraction &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;rain_fraction.tif&#39;</span>))</span>
<span id="cb239-15"><a href="spatial-data-in-r.html#cb239-15"></a></span>
<span id="cb239-16"><a href="spatial-data-in-r.html#cb239-16"></a><span class="co"># annual sum of monthly PPT - ET_p</span></span>
<span id="cb239-17"><a href="spatial-data-in-r.html#cb239-17"></a>ppt_eff &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">file.path</span>(ch2b.data.path, <span class="st">&#39;effective_preciptitation.tif&#39;</span>))</span></code></pre></div>
<p>Sometimes it is convenient to “stack” raster data that share a common grid size, extent, and coordinate reference system into a single <code>RasterStack</code> object.</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="spatial-data-in-r.html#cb240-1"></a><span class="co"># create a raster stack (multiple rasters aligned)</span></span>
<span id="cb240-2"><a href="spatial-data-in-r.html#cb240-2"></a>rs &lt;-<span class="st"> </span><span class="kw">stack</span>(maat, map, ffd, gdd, rain_fraction, ppt_eff)</span>
<span id="cb240-3"><a href="spatial-data-in-r.html#cb240-3"></a></span>
<span id="cb240-4"><a href="spatial-data-in-r.html#cb240-4"></a><span class="co"># reset layer names</span></span>
<span id="cb240-5"><a href="spatial-data-in-r.html#cb240-5"></a><span class="kw">names</span>(rs) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;MAAT&#39;</span>, <span class="st">&#39;MAP&#39;</span>, <span class="st">&#39;FFD&#39;</span>, <span class="st">&#39;GDD&#39;</span>, <span class="st">&#39;rain.fraction&#39;</span>, <span class="st">&#39;eff.PPT&#39;</span>)</span></code></pre></div>
<p>Quick inspection of the data.</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="spatial-data-in-r.html#cb241-1"></a><span class="co"># object class</span></span>
<span id="cb241-2"><a href="spatial-data-in-r.html#cb241-2"></a><span class="kw">class</span>(mlra)</span></code></pre></div>
<pre><code>## [1] &quot;SpatialPolygonsDataFrame&quot;
## attr(,&quot;package&quot;)
## [1] &quot;sp&quot;</code></pre>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="spatial-data-in-r.html#cb243-1"></a><span class="kw">class</span>(maat)</span></code></pre></div>
<pre><code>## [1] &quot;RasterLayer&quot;
## attr(,&quot;package&quot;)
## [1] &quot;raster&quot;</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="spatial-data-in-r.html#cb245-1"></a><span class="kw">class</span>(rs)</span></code></pre></div>
<pre><code>## [1] &quot;RasterStack&quot;
## attr(,&quot;package&quot;)
## [1] &quot;raster&quot;</code></pre>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="spatial-data-in-r.html#cb247-1"></a><span class="co"># the raster package provides a nice &quot;print&quot; method for raster and sp classes</span></span>
<span id="cb247-2"><a href="spatial-data-in-r.html#cb247-2"></a><span class="kw">print</span>(maat)</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## dimensions : 762, 616, 469392  (nrow, ncol, ncell)
## resolution : 0.008333333, 0.008333333  (x, y)
## extent     : -123.2708, -118.1375, 34.44583, 40.79583  (xmin, xmax, ymin, ymax)
## crs        : +proj=longlat +ellps=GRS80 +no_defs 
## source     : C:/workspace2/chapter-2b/MAAT.tif 
## names      : MAAT 
## values     : -4.073542, 18.67642  (min, max)</code></pre>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="spatial-data-in-r.html#cb249-1"></a><span class="co"># coordinate reference systems: note that they are not all the same</span></span>
<span id="cb249-2"><a href="spatial-data-in-r.html#cb249-2"></a><span class="kw">proj4string</span>(mlra)</span></code></pre></div>
<pre><code>## [1] &quot;+proj=aea +lat_0=23 +lon_0=-96 +lat_1=29.5 +lat_2=45.5 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs&quot;</code></pre>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="spatial-data-in-r.html#cb251-1"></a><span class="kw">proj4string</span>(maat)</span></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +ellps=GRS80 +no_defs&quot;</code></pre>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="spatial-data-in-r.html#cb253-1"></a><span class="kw">proj4string</span>(rs)</span></code></pre></div>
<pre><code>## [1] &quot;+proj=longlat +ellps=GRS80 +no_defs&quot;</code></pre>
<p>Basic plot methods (class-specific functions) for the data. Note that this approach requires that all layers in the “map” are in the same coordinate refrence system (CRS).</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="spatial-data-in-r.html#cb255-1"></a><span class="co"># MLRA polygons in native coordinate system</span></span>
<span id="cb255-2"><a href="spatial-data-in-r.html#cb255-2"></a><span class="co"># recall that mlra is a SpatialPolygonsDataFrame</span></span>
<span id="cb255-3"><a href="spatial-data-in-r.html#cb255-3"></a><span class="kw">plot</span>(mlra, <span class="dt">main =</span> <span class="st">&#39;MLRA 15 and 18&#39;</span>)</span>
<span id="cb255-4"><a href="spatial-data-in-r.html#cb255-4"></a><span class="kw">box</span>()</span>
<span id="cb255-5"><a href="spatial-data-in-r.html#cb255-5"></a></span>
<span id="cb255-6"><a href="spatial-data-in-r.html#cb255-6"></a><span class="co"># MAAT raster</span></span>
<span id="cb255-7"><a href="spatial-data-in-r.html#cb255-7"></a><span class="co"># recall that maat is a raster object</span></span>
<span id="cb255-8"><a href="spatial-data-in-r.html#cb255-8"></a><span class="kw">plot</span>(maat, <span class="dt">main =</span> <span class="st">&#39;PRISM Mean Annual Air Temperature (deg C)&#39;</span>)</span>
<span id="cb255-9"><a href="spatial-data-in-r.html#cb255-9"></a></span>
<span id="cb255-10"><a href="spatial-data-in-r.html#cb255-10"></a><span class="co"># plot MAAT raster with MLRA polygons on top</span></span>
<span id="cb255-11"><a href="spatial-data-in-r.html#cb255-11"></a><span class="co"># this requires transforming to CRS of MAAT</span></span>
<span id="cb255-12"><a href="spatial-data-in-r.html#cb255-12"></a>mlra.gcs &lt;-<span class="st"> </span><span class="kw">spTransform</span>(mlra, <span class="kw">CRS</span>(<span class="kw">proj4string</span>(maat)))</span>
<span id="cb255-13"><a href="spatial-data-in-r.html#cb255-13"></a><span class="kw">plot</span>(maat, <span class="dt">main =</span> <span class="st">&#39;PRISM Mean Annual Air Temperature (deg C)&#39;</span>)</span>
<span id="cb255-14"><a href="spatial-data-in-r.html#cb255-14"></a><span class="kw">plot</span>(mlra.gcs, <span class="dt">main =</span> <span class="st">&#39;MLRA 15 and 18&#39;</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
</div>
<div id="spatial-overlay-operations" class="section level3">
<h3><span class="header-section-number">4.6.4</span> Spatial Overlay Operations</h3>
<p>Spatial data are lot more useful when “combined” (overlay, intersect, spatial query, etc.) to generate something new. For simplicity, we will refer to this kind of operation as an “extraction”. The CRS of the two objects being overlaid must match.</p>
<div id="vector-data" class="section level4">
<h4><span class="header-section-number">4.6.4.1</span> Vector data</h4>
<p>In <code>sf</code> the functions used to do this are <code>st_intersects()</code> or <code>st_intersection()</code>.</p>
<p>In <code>sp</code> objects, you do these operations with the <code>sp::over()</code> function. Access the associated vignette by pasting <code>vignette("over")</code> in the console.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="spatial-data-in-r.html#cb256-1"></a><span class="co"># hand make a SpatialPoints object</span></span>
<span id="cb256-2"><a href="spatial-data-in-r.html#cb256-2"></a><span class="co"># note that this is GCS</span></span>
<span id="cb256-3"><a href="spatial-data-in-r.html#cb256-3"></a>p &lt;-<span class="st"> </span><span class="kw">SpatialPoints</span>(<span class="dt">coords =</span> <span class="kw">cbind</span>(<span class="op">-</span><span class="dv">120</span>, <span class="fl">37.5</span>), </span>
<span id="cb256-4"><a href="spatial-data-in-r.html#cb256-4"></a>                   <span class="dt">proj4string =</span> <span class="kw">CRS</span>(<span class="st">&#39;+proj=longlat +datum=WGS84&#39;</span>))</span>
<span id="cb256-5"><a href="spatial-data-in-r.html#cb256-5"></a></span>
<span id="cb256-6"><a href="spatial-data-in-r.html#cb256-6"></a><span class="co"># spatial extraction of MLRA data requires a CRS transformation</span></span>
<span id="cb256-7"><a href="spatial-data-in-r.html#cb256-7"></a>p.aea &lt;-<span class="st"> </span><span class="kw">spTransform</span>(p, <span class="kw">proj4string</span>(mlra))</span>
<span id="cb256-8"><a href="spatial-data-in-r.html#cb256-8"></a><span class="kw">over</span>(p.aea, mlra)</span></code></pre></div>
</div>
<div id="raster-data" class="section level4">
<h4><span class="header-section-number">4.6.4.2</span> Raster Data</h4>
<p>The values stored in a <code>RasterLayer</code> or <code>RasterStack</code> object can be extracted using the <code>extract()</code> function.</p>
<p>As long a the “query” feature has a valid CRS defined, the <code>raster::extract()</code> function will automatically perform any required CRS transformation.</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb257-1"><a href="spatial-data-in-r.html#cb257-1"></a><span class="co"># extract from a single RasterLayer</span></span>
<span id="cb257-2"><a href="spatial-data-in-r.html#cb257-2"></a><span class="kw">extract</span>(maat, p)</span>
<span id="cb257-3"><a href="spatial-data-in-r.html#cb257-3"></a></span>
<span id="cb257-4"><a href="spatial-data-in-r.html#cb257-4"></a><span class="co"># extract from a RasterStack</span></span>
<span id="cb257-5"><a href="spatial-data-in-r.html#cb257-5"></a><span class="kw">extract</span>(rs, p)</span></code></pre></div>
</div>
</div>
<div id="sampling-and-extraction" class="section level3">
<h3><span class="header-section-number">4.6.5</span> Sampling and Extraction</h3>
<div id="raster-data-sampling" class="section level4">
<h4><span class="header-section-number">4.6.5.1</span> Raster Data Sampling</h4>
<p>Typically, spatial queries of raster data by polygon features are performed in two ways:</p>
<ol style="list-style-type: decimal">
<li><p>for each polygon, collect all pixels that overlap (<code>exactextractr</code> approach)</p></li>
<li><p>for each polygon, collect a sample of pixels defined by <a href="http://ncss-tech.github.io/AQP/sharpshootR/sample-vs-population.html">sampling points</a></p></li>
</ol>
<p>The first method ensures that all data are included in the analysis, however, processing can be slow for multiple/detailed rasters, and the results may not fit into memory.</p>
<p>The second method is more efficient (10-100x faster), requires less memory, and can remain statistically sound–as long as a reasonable sampling strategy is applied. Sampling may also help you avoid low-acreage “anomalies” in the raster product. More on sampling methods in the next chapter.</p>
<p>The <code>extract()</code> function can perform several operations in one pass, such as buffering (in projected units) then extracting. See the manual page for an extensive listing of optional arguments and what they do.</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="spatial-data-in-r.html#cb258-1"></a><span class="co"># extract using a buffer with radius specified in meters (1000m)</span></span>
<span id="cb258-2"><a href="spatial-data-in-r.html#cb258-2"></a><span class="kw">extract</span>(rs, p, <span class="dt">buffer =</span> <span class="dv">1000</span>)</span></code></pre></div>
<p>Sampling and extraction with <code>raster</code> methods results in a <code>matrix</code> object.</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="spatial-data-in-r.html#cb259-1"></a><span class="co"># sampling single RasterLayer</span></span>
<span id="cb259-2"><a href="spatial-data-in-r.html#cb259-2"></a><span class="kw">sampleRegular</span>(maat, <span class="dt">size =</span> <span class="dv">10</span>)</span>
<span id="cb259-3"><a href="spatial-data-in-r.html#cb259-3"></a></span>
<span id="cb259-4"><a href="spatial-data-in-r.html#cb259-4"></a><span class="co"># sampling RasterStack</span></span>
<span id="cb259-5"><a href="spatial-data-in-r.html#cb259-5"></a><span class="kw">sampleRegular</span>(rs, <span class="dt">size =</span> <span class="dv">10</span>)</span></code></pre></div>
<p>Sampling and extract, result is a <code>SpatialPointsDataFrame</code> object.</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="spatial-data-in-r.html#cb260-1"></a><span class="kw">par</span>(<span class="dt">mfcol =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb260-2"><a href="spatial-data-in-r.html#cb260-2"></a></span>
<span id="cb260-3"><a href="spatial-data-in-r.html#cb260-3"></a><span class="co"># regular sampling + extraction of raster values</span></span>
<span id="cb260-4"><a href="spatial-data-in-r.html#cb260-4"></a>x.regular &lt;-<span class="st"> </span><span class="kw">sampleRegular</span>(maat, <span class="dt">size =</span> <span class="dv">100</span>, <span class="dt">sp =</span> <span class="ot">TRUE</span>)</span>
<span id="cb260-5"><a href="spatial-data-in-r.html#cb260-5"></a><span class="kw">plot</span>(maat,</span>
<span id="cb260-6"><a href="spatial-data-in-r.html#cb260-6"></a>     <span class="dt">axes =</span> <span class="ot">FALSE</span>,</span>
<span id="cb260-7"><a href="spatial-data-in-r.html#cb260-7"></a>     <span class="dt">legend =</span> <span class="ot">FALSE</span>,</span>
<span id="cb260-8"><a href="spatial-data-in-r.html#cb260-8"></a>     <span class="dt">main =</span> <span class="st">&#39;Regular Sampling&#39;</span>)</span>
<span id="cb260-9"><a href="spatial-data-in-r.html#cb260-9"></a><span class="kw">points</span>(x.regular)</span>
<span id="cb260-10"><a href="spatial-data-in-r.html#cb260-10"></a></span>
<span id="cb260-11"><a href="spatial-data-in-r.html#cb260-11"></a><span class="co"># random sample + extraction of raster values</span></span>
<span id="cb260-12"><a href="spatial-data-in-r.html#cb260-12"></a><span class="co"># note that NULL values are removed</span></span>
<span id="cb260-13"><a href="spatial-data-in-r.html#cb260-13"></a>x.random &lt;-<span class="st"> </span><span class="kw">sampleRandom</span>(maat,</span>
<span id="cb260-14"><a href="spatial-data-in-r.html#cb260-14"></a>                         <span class="dt">size =</span> <span class="dv">100</span>,</span>
<span id="cb260-15"><a href="spatial-data-in-r.html#cb260-15"></a>                         <span class="dt">sp =</span> <span class="ot">TRUE</span>,</span>
<span id="cb260-16"><a href="spatial-data-in-r.html#cb260-16"></a>                         <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb260-17"><a href="spatial-data-in-r.html#cb260-17"></a><span class="kw">plot</span>(maat,</span>
<span id="cb260-18"><a href="spatial-data-in-r.html#cb260-18"></a>     <span class="dt">axes =</span> <span class="ot">FALSE</span>,</span>
<span id="cb260-19"><a href="spatial-data-in-r.html#cb260-19"></a>     <span class="dt">legend =</span> <span class="ot">FALSE</span>,</span>
<span id="cb260-20"><a href="spatial-data-in-r.html#cb260-20"></a>     <span class="dt">main =</span> <span class="st">&#39;Random Sampling with NA Removal&#39;</span>)</span>
<span id="cb260-21"><a href="spatial-data-in-r.html#cb260-21"></a></span>
<span id="cb260-22"><a href="spatial-data-in-r.html#cb260-22"></a><span class="kw">points</span>(x.random)</span></code></pre></div>
<p>Note that the mean can be efficiently estimated, even with a relatively small number of samples.</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="spatial-data-in-r.html#cb261-1"></a><span class="co"># all values: slow for large grids</span></span>
<span id="cb261-2"><a href="spatial-data-in-r.html#cb261-2"></a><span class="kw">mean</span>(<span class="kw">values</span>(maat), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb261-3"><a href="spatial-data-in-r.html#cb261-3"></a></span>
<span id="cb261-4"><a href="spatial-data-in-r.html#cb261-4"></a><span class="co"># regular sampling: efficient, central tendency comparable to above</span></span>
<span id="cb261-5"><a href="spatial-data-in-r.html#cb261-5"></a><span class="kw">mean</span>(x.regular<span class="op">$</span>MAAT, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb261-6"><a href="spatial-data-in-r.html#cb261-6"></a></span>
<span id="cb261-7"><a href="spatial-data-in-r.html#cb261-7"></a><span class="co"># this value will be pseudorandom</span></span>
<span id="cb261-8"><a href="spatial-data-in-r.html#cb261-8"></a><span class="co">#  depends on number of samples, pattern of NA</span></span>
<span id="cb261-9"><a href="spatial-data-in-r.html#cb261-9"></a><span class="kw">mean</span>(x.random<span class="op">$</span>MAAT, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>Just how much variation can we expect when collecting 100, randomly-located samples over such a large area? This is better covered in chapter 4 (Sampling), but a quick experiment might be fun. Do this 100 times: compute the mean MAAT from 100 randomly-located samples.</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="spatial-data-in-r.html#cb262-1"></a><span class="co"># takes a couple of seconds</span></span>
<span id="cb262-2"><a href="spatial-data-in-r.html#cb262-2"></a>z &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">30</span>, <span class="kw">mean</span>(<span class="kw">sampleRandom</span>(maat, <span class="dt">size =</span> <span class="dv">100</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span>
<span id="cb262-3"><a href="spatial-data-in-r.html#cb262-3"></a></span>
<span id="cb262-4"><a href="spatial-data-in-r.html#cb262-4"></a><span class="co"># 90% of the time the mean MAAT values were within:</span></span>
<span id="cb262-5"><a href="spatial-data-in-r.html#cb262-5"></a><span class="kw">quantile</span>(z, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))</span></code></pre></div>
</div>
<div id="extracting-raster-data-kssl-pedon-locations" class="section level4">
<h4><span class="header-section-number">4.6.5.2</span> Extracting Raster Data: KSSL Pedon Locations</h4>
<p>Extract PRISM data at the coordinates associated with KSSL pedons that have been correlated to the <a href="https://casoilresource.lawr.ucdavis.edu/sde/?series=auburn">AUBURN</a> series.</p>
<p>We will use the <a href="http://ncss-tech.github.io/AQP/soilDB/KSSL-demo.html"><code>fetchKSSL()</code></a> function from the <code>soilDB</code> package to get KSSL data from the most recent snapshot. This example can be easily adapted to pedon data extracted from NASIS using <a href="http://ncss-tech.github.io/AQP/soilDB/fetchNASIS-mini-tutorial.html"><code>fetchNASIS()</code></a>.</p>
<p>Get some KSSL data and upgrade the “site” data to a <code>SpatialPointsDataFrame</code>.</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="spatial-data-in-r.html#cb263-1"></a><span class="co"># result is a SoilProfileCollection object</span></span>
<span id="cb263-2"><a href="spatial-data-in-r.html#cb263-2"></a>auburn &lt;-<span class="st"> </span><span class="kw">fetchKSSL</span>(<span class="dt">series =</span> <span class="st">&#39;auburn&#39;</span>)</span>
<span id="cb263-3"><a href="spatial-data-in-r.html#cb263-3"></a></span>
<span id="cb263-4"><a href="spatial-data-in-r.html#cb263-4"></a><span class="co"># extract site data</span></span>
<span id="cb263-5"><a href="spatial-data-in-r.html#cb263-5"></a>s &lt;-<span class="st"> </span><span class="kw">site</span>(auburn)</span>
<span id="cb263-6"><a href="spatial-data-in-r.html#cb263-6"></a></span>
<span id="cb263-7"><a href="spatial-data-in-r.html#cb263-7"></a><span class="co"># these are GCS WGS84 coordinates from NASIS</span></span>
<span id="cb263-8"><a href="spatial-data-in-r.html#cb263-8"></a><span class="kw">coordinates</span>(s) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>x <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb263-9"><a href="spatial-data-in-r.html#cb263-9"></a><span class="kw">proj4string</span>(s) &lt;-<span class="st"> &#39;+proj=longlat +datum=WGS84&#39;</span></span></code></pre></div>
<p>Extract PRISM data (the <code>RasterStack</code> object we made earlier) at the Auburn KSSL locations and summarize.</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="spatial-data-in-r.html#cb264-1"></a><span class="co"># return the result as a data.frame object</span></span>
<span id="cb264-2"><a href="spatial-data-in-r.html#cb264-2"></a>e &lt;-<span class="st"> </span><span class="kw">extract</span>(rs, s, <span class="dt">df=</span><span class="ot">TRUE</span>)</span>
<span id="cb264-3"><a href="spatial-data-in-r.html#cb264-3"></a></span>
<span id="cb264-4"><a href="spatial-data-in-r.html#cb264-4"></a><span class="co"># summarize: remove first (ID) column using [, -1] j index</span></span>
<span id="cb264-5"><a href="spatial-data-in-r.html#cb264-5"></a><span class="kw">summary</span>(e[, <span class="dv">-1</span>])</span></code></pre></div>
<pre><code>##       MAAT            MAP             FFD             GDD       rain.fraction    eff.PPT      
##  Min.   :15.52   Min.   :448.0   Min.   :278.0   Min.   :2456   Min.   :99    Min.   :-409.0  
##  1st Qu.:16.24   1st Qu.:519.0   1st Qu.:305.5   1st Qu.:2586   1st Qu.:99    1st Qu.:-329.1  
##  Median :16.45   Median :569.5   Median :316.0   Median :2608   Median :99    Median :-282.3  
##  Mean   :16.33   Mean   :633.3   Mean   :314.4   Mean   :2588   Mean   :99    Mean   :-208.6  
##  3rd Qu.:16.60   3rd Qu.:661.0   3rd Qu.:329.5   3rd Qu.:2623   3rd Qu.:99    3rd Qu.:-188.4  
##  Max.   :16.65   Max.   :947.0   Max.   :334.0   Max.   :2651   Max.   :99    Max.   : 128.4</code></pre>
<p>Join the extracted PRISM data with the original <code>SoilProfileCollection</code> object.</p>
<p>More information on <a href="http://ncss-tech.github.io/AQP/aqp/aqp-intro.html"><code>SoilProfileCollection objects here</code></a>.</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb266-1"><a href="spatial-data-in-r.html#cb266-1"></a><span class="co"># don&#39;t convert character data into factors</span></span>
<span id="cb266-2"><a href="spatial-data-in-r.html#cb266-2"></a><span class="kw">options</span>(<span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</span>
<span id="cb266-3"><a href="spatial-data-in-r.html#cb266-3"></a></span>
<span id="cb266-4"><a href="spatial-data-in-r.html#cb266-4"></a><span class="co"># combine site data with extracted raster values, row-order is identical</span></span>
<span id="cb266-5"><a href="spatial-data-in-r.html#cb266-5"></a>res &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="kw">as</span>(s, <span class="st">&#39;data.frame&#39;</span>), e)</span>
<span id="cb266-6"><a href="spatial-data-in-r.html#cb266-6"></a></span>
<span id="cb266-7"><a href="spatial-data-in-r.html#cb266-7"></a><span class="co"># extract unique IDs and PRISM data</span></span>
<span id="cb266-8"><a href="spatial-data-in-r.html#cb266-8"></a>res &lt;-<span class="st"> </span>res[, <span class="kw">c</span>(<span class="st">&#39;pedon_key&#39;</span>, <span class="st">&#39;MAAT&#39;</span>, <span class="st">&#39;MAP&#39;</span>, <span class="st">&#39;FFD&#39;</span>, <span class="st">&#39;GDD&#39;</span>, <span class="st">&#39;rain.fraction&#39;</span>, <span class="st">&#39;eff.PPT&#39;</span>)]</span>
<span id="cb266-9"><a href="spatial-data-in-r.html#cb266-9"></a></span>
<span id="cb266-10"><a href="spatial-data-in-r.html#cb266-10"></a><span class="co"># join with original SoilProfileCollection object via pedon_key</span></span>
<span id="cb266-11"><a href="spatial-data-in-r.html#cb266-11"></a><span class="kw">site</span>(auburn) &lt;-<span class="st"> </span>res</span></code></pre></div>
<p>The extracted values are now part of the “auburn” <code>SoilProfileCollection</code> object.</p>
<p>Does there appear to be a relationship between soil morphology and “effective precipitation”? Not really.</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="spatial-data-in-r.html#cb267-1"></a><span class="co"># create an ordering of pedons based on the extracted effective PPT</span></span>
<span id="cb267-2"><a href="spatial-data-in-r.html#cb267-2"></a>new.order &lt;-<span class="st"> </span><span class="kw">order</span>(auburn<span class="op">$</span>eff.PPT)</span>
<span id="cb267-3"><a href="spatial-data-in-r.html#cb267-3"></a></span>
<span id="cb267-4"><a href="spatial-data-in-r.html#cb267-4"></a><span class="co"># setup figure margins, 1x1 row*column layout</span></span>
<span id="cb267-5"><a href="spatial-data-in-r.html#cb267-5"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">2</span>), <span class="dt">mfcol =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb267-6"><a href="spatial-data-in-r.html#cb267-6"></a></span>
<span id="cb267-7"><a href="spatial-data-in-r.html#cb267-7"></a><span class="co"># plot profile sketches</span></span>
<span id="cb267-8"><a href="spatial-data-in-r.html#cb267-8"></a><span class="kw">plot</span>(auburn,</span>
<span id="cb267-9"><a href="spatial-data-in-r.html#cb267-9"></a>     <span class="dt">name =</span> <span class="st">&#39;hzn_desgn&#39;</span>,</span>
<span id="cb267-10"><a href="spatial-data-in-r.html#cb267-10"></a>     <span class="dt">print.id =</span> <span class="ot">FALSE</span>,</span>
<span id="cb267-11"><a href="spatial-data-in-r.html#cb267-11"></a>     <span class="dt">color =</span> <span class="st">&#39;clay&#39;</span>,</span>
<span id="cb267-12"><a href="spatial-data-in-r.html#cb267-12"></a>     <span class="dt">plot.order =</span> new.order,</span>
<span id="cb267-13"><a href="spatial-data-in-r.html#cb267-13"></a>     <span class="dt">cex.names =</span> <span class="fl">0.85</span>)</span>
<span id="cb267-14"><a href="spatial-data-in-r.html#cb267-14"></a></span>
<span id="cb267-15"><a href="spatial-data-in-r.html#cb267-15"></a><span class="co"># add an axis with extracted raster values</span></span>
<span id="cb267-16"><a href="spatial-data-in-r.html#cb267-16"></a><span class="kw">axis</span>(<span class="dt">side =</span> <span class="dv">1</span>,</span>
<span id="cb267-17"><a href="spatial-data-in-r.html#cb267-17"></a>     <span class="dt">at =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(auburn),</span>
<span id="cb267-18"><a href="spatial-data-in-r.html#cb267-18"></a>     <span class="dt">labels =</span> <span class="kw">round</span>(auburn<span class="op">$</span>eff.PPT[new.order]),</span>
<span id="cb267-19"><a href="spatial-data-in-r.html#cb267-19"></a>     <span class="dt">cex.axis =</span> <span class="fl">0.75</span>)</span>
<span id="cb267-20"><a href="spatial-data-in-r.html#cb267-20"></a></span>
<span id="cb267-21"><a href="spatial-data-in-r.html#cb267-21"></a><span class="kw">mtext</span>(<span class="st">&#39;Annual Sum of Monthly (PPT - ET_p) (mm)&#39;</span>,</span>
<span id="cb267-22"><a href="spatial-data-in-r.html#cb267-22"></a>      <span class="dt">side =</span> <span class="dv">1</span>,</span>
<span id="cb267-23"><a href="spatial-data-in-r.html#cb267-23"></a>      <span class="dt">line =</span> <span class="fl">2.5</span>)</span></code></pre></div>
<p><img src="newbook_files/figure-html/unnamed-chunk-149-1.png" width="1152" /></p>
<p>Note that negative values are associated with a net deficit in monthly precipitation vs. estimated ET.</p>
</div>
<div id="raster-summary-by-polygon-series-extent" class="section level4">
<h4><span class="header-section-number">4.6.5.3</span> Raster Summary By Polygon: Series Extent</h4>
<p>The <a href="http://ncss-tech.github.io/AQP/soilDB/series-extent.html"><code>seriesExtent()</code></a> function from the <code>soilDB</code> package provides a simple interface to <a href="https://casoilresource.lawr.ucdavis.edu/see/">Series Extent Explorer</a> data files.</p>
<p>Note that these series extents have been generalized for rapid display at regional to continental scales. A more precise representation of “series extent” can be generated from SSURGO polygons and queried from <a href="http://ncss-tech.github.io/AQP/soilDB/SDA-tutorial-2.html">SDA</a>.</p>
<p>Get an approximate extent for the <a href="http://casoilresource.lawr.ucdavis.edu/sde/?series=amador">Amador</a> soil series from <a href="https://casoilresource.lawr.ucdavis.edu/see/#amador">SEE</a>. See the manual page for <code>seriesExtent</code> for additional options and related functions.</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="spatial-data-in-r.html#cb268-1"></a>amador &lt;-<span class="st"> </span><span class="kw">seriesExtent</span>(<span class="dt">s =</span> <span class="st">&#39;amador&#39;</span>)</span>
<span id="cb268-2"><a href="spatial-data-in-r.html#cb268-2"></a><span class="kw">class</span>(amador)</span></code></pre></div>
<pre><code>## [1] &quot;SpatialPolygonsDataFrame&quot;
## attr(,&quot;package&quot;)
## [1] &quot;sp&quot;</code></pre>
<p>Generate 100 sampling points within the extent, using a hexagonal grid. These will be used to extract raster values from our <code>RasterStack</code> of PRISM data.</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="spatial-data-in-r.html#cb270-1"></a>s &lt;-<span class="st"> </span><span class="kw">spsample</span>(amador, <span class="dt">n =</span> <span class="dv">100</span>, <span class="dt">type =</span> <span class="st">&#39;hexagonal&#39;</span>)</span></code></pre></div>
<p>For comparison, extract a single point from each SSURGO map unit delineation that contains <em>Amador</em> as a major component. This will require a query to SDA for the set of matching map unit keys (<code>mukey</code>), followed by a second request to SDA for the geometry.</p>
<p>The <code>SDA_query</code> function is used to send arbitrary queries written in SQL to SDA, the results may be a <code>data.frame</code> or <code>list</code>, depending on the complexity of the query. The <code>fetchSDA_spatial</code> function returns map unit geometry as either polygons, polygon envelopes, or a single point per polygon and selected by <code>mukey</code> or <code>nationalmusym</code>.</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="spatial-data-in-r.html#cb271-1"></a><span class="co"># result is a data.frame</span></span>
<span id="cb271-2"><a href="spatial-data-in-r.html#cb271-2"></a>mukeys &lt;-<span class="st"> </span><span class="kw">SDA_query</span>(<span class="st">&quot;SELECT DISTINCT mukey FROM component</span></span>
<span id="cb271-3"><a href="spatial-data-in-r.html#cb271-3"></a><span class="st">                     WHERE compname = &#39;Amador&#39; AND majcompflag = &#39;Yes&#39;;&quot;</span>)</span>
<span id="cb271-4"><a href="spatial-data-in-r.html#cb271-4"></a></span>
<span id="cb271-5"><a href="spatial-data-in-r.html#cb271-5"></a><span class="co"># result is a SpatialPointsDataFrame</span></span>
<span id="cb271-6"><a href="spatial-data-in-r.html#cb271-6"></a>amador.pts &lt;-<span class="st"> </span><span class="kw">fetchSDA_spatial</span>(mukeys<span class="op">$</span>mukey,</span>
<span id="cb271-7"><a href="spatial-data-in-r.html#cb271-7"></a>                               <span class="dt">by.col =</span> <span class="st">&#39;mukey&#39;</span>,</span>
<span id="cb271-8"><a href="spatial-data-in-r.html#cb271-8"></a>                               <span class="dt">method =</span> <span class="st">&#39;point&#39;</span>,</span>
<span id="cb271-9"><a href="spatial-data-in-r.html#cb271-9"></a>                               <span class="dt">chunk.size =</span> <span class="dv">2</span>)</span></code></pre></div>
<p>Graphically check both methods:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="spatial-data-in-r.html#cb272-1"></a><span class="co"># adjust margins and setup plot device for two columns</span></span>
<span id="cb272-2"><a href="spatial-data-in-r.html#cb272-2"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">1</span>), <span class="dt">mfcol =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb272-3"><a href="spatial-data-in-r.html#cb272-3"></a></span>
<span id="cb272-4"><a href="spatial-data-in-r.html#cb272-4"></a><span class="co"># first figure</span></span>
<span id="cb272-5"><a href="spatial-data-in-r.html#cb272-5"></a><span class="kw">plot</span>(maat,</span>
<span id="cb272-6"><a href="spatial-data-in-r.html#cb272-6"></a>     <span class="dt">ext =</span> <span class="kw">extent</span>(s),</span>
<span id="cb272-7"><a href="spatial-data-in-r.html#cb272-7"></a>     <span class="dt">main =</span> <span class="st">&#39;PRISM MAAT</span><span class="ch">\n</span><span class="st">100 Sampling Points from Extent&#39;</span>,</span>
<span id="cb272-8"><a href="spatial-data-in-r.html#cb272-8"></a>     <span class="dt">axes =</span> <span class="ot">FALSE</span>)</span>
<span id="cb272-9"><a href="spatial-data-in-r.html#cb272-9"></a><span class="kw">plot</span>(amador, <span class="dt">add =</span> <span class="ot">TRUE</span>)</span>
<span id="cb272-10"><a href="spatial-data-in-r.html#cb272-10"></a><span class="kw">points</span>(s, <span class="dt">cex =</span> <span class="fl">0.25</span>)</span>
<span id="cb272-11"><a href="spatial-data-in-r.html#cb272-11"></a></span>
<span id="cb272-12"><a href="spatial-data-in-r.html#cb272-12"></a><span class="kw">plot</span>(maat,</span>
<span id="cb272-13"><a href="spatial-data-in-r.html#cb272-13"></a>     <span class="dt">ext =</span> <span class="kw">extent</span>(s),</span>
<span id="cb272-14"><a href="spatial-data-in-r.html#cb272-14"></a>     <span class="dt">main =</span> <span class="st">&#39;PRISM MAAT</span><span class="ch">\n</span><span class="st">Polygon Centroids&#39;</span>,</span>
<span id="cb272-15"><a href="spatial-data-in-r.html#cb272-15"></a>     <span class="dt">axes =</span> <span class="ot">FALSE</span>)</span>
<span id="cb272-16"><a href="spatial-data-in-r.html#cb272-16"></a><span class="kw">points</span>(amador.pts, <span class="dt">cex =</span> <span class="fl">0.25</span>)</span></code></pre></div>
<p><img src="newbook_files/figure-html/unnamed-chunk-153-1.png" width="960" /></p>
<p>Extract PRISM data (the <code>RasterStack</code> object we made earlier) at the sampling locations (100 regularly-spaced and from MU polygon centroids) and summarize. Note that CRS transformations are automatic (when possible).</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="spatial-data-in-r.html#cb273-1"></a><span class="co"># return the result as a data.frame object</span></span>
<span id="cb273-2"><a href="spatial-data-in-r.html#cb273-2"></a>e &lt;-<span class="st"> </span><span class="kw">extract</span>(rs, s, <span class="dt">df =</span> <span class="ot">TRUE</span>)</span>
<span id="cb273-3"><a href="spatial-data-in-r.html#cb273-3"></a>e.pts &lt;-<span class="st"> </span><span class="kw">extract</span>(rs, amador.pts, <span class="dt">df =</span> <span class="ot">TRUE</span>)</span>
<span id="cb273-4"><a href="spatial-data-in-r.html#cb273-4"></a></span>
<span id="cb273-5"><a href="spatial-data-in-r.html#cb273-5"></a><span class="co"># check out the extracted data</span></span>
<span id="cb273-6"><a href="spatial-data-in-r.html#cb273-6"></a><span class="kw">summary</span>(e[,<span class="op">-</span><span class="dv">1</span>])</span></code></pre></div>
<pre><code>##       MAAT            MAP             FFD             GDD       rain.fraction       eff.PPT      
##  Min.   :16.52   Min.   :331.0   Min.   :312.0   Min.   :2590   Min.   : 99.00   Min.   :-557.9  
##  1st Qu.:16.60   1st Qu.:444.0   1st Qu.:323.2   1st Qu.:2624   1st Qu.: 99.00   1st Qu.:-415.5  
##  Median :16.65   Median :488.0   Median :330.0   Median :2642   Median : 99.00   Median :-353.3  
##  Mean   :16.65   Mean   :481.9   Mean   :329.0   Mean   :2643   Mean   : 99.01   Mean   :-366.8  
##  3rd Qu.:16.68   3rd Qu.:539.0   3rd Qu.:335.0   3rd Qu.:2665   3rd Qu.: 99.00   3rd Qu.:-293.3  
##  Max.   :17.05   Max.   :599.0   Max.   :341.0   Max.   :2758   Max.   :100.00   Max.   :-226.0</code></pre>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="spatial-data-in-r.html#cb275-1"></a><span class="co"># all pair-wise correlations</span></span>
<span id="cb275-2"><a href="spatial-data-in-r.html#cb275-2"></a>knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">cor</span>(e[,<span class="op">-</span><span class="dv">1</span>]), <span class="dt">digits =</span> <span class="dv">2</span>)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">MAAT</th>
<th align="right">MAP</th>
<th align="right">FFD</th>
<th align="right">GDD</th>
<th align="right">rain.fraction</th>
<th align="right">eff.PPT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MAAT</td>
<td align="right">1.00</td>
<td align="right">-0.47</td>
<td align="right">-0.12</td>
<td align="right">0.74</td>
<td align="right">0.03</td>
<td align="right">-0.47</td>
</tr>
<tr class="even">
<td align="left">MAP</td>
<td align="right">-0.47</td>
<td align="right">1.00</td>
<td align="right">0.68</td>
<td align="right">-0.87</td>
<td align="right">-0.01</td>
<td align="right">0.99</td>
</tr>
<tr class="odd">
<td align="left">FFD</td>
<td align="right">-0.12</td>
<td align="right">0.68</td>
<td align="right">1.00</td>
<td align="right">-0.63</td>
<td align="right">-0.06</td>
<td align="right">0.71</td>
</tr>
<tr class="even">
<td align="left">GDD</td>
<td align="right">0.74</td>
<td align="right">-0.87</td>
<td align="right">-0.63</td>
<td align="right">1.00</td>
<td align="right">0.11</td>
<td align="right">-0.87</td>
</tr>
<tr class="odd">
<td align="left">rain.fraction</td>
<td align="right">0.03</td>
<td align="right">-0.01</td>
<td align="right">-0.06</td>
<td align="right">0.11</td>
<td align="right">1.00</td>
<td align="right">-0.02</td>
</tr>
<tr class="even">
<td align="left">eff.PPT</td>
<td align="right">-0.47</td>
<td align="right">0.99</td>
<td align="right">0.71</td>
<td align="right">-0.87</td>
<td align="right">-0.02</td>
<td align="right">1.00</td>
</tr>
</tbody>
</table>
<p>Quickly compare the two sets of samples. More on this in the Sampling module.</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="spatial-data-in-r.html#cb276-1"></a><span class="co"># compile results into a list</span></span>
<span id="cb276-2"><a href="spatial-data-in-r.html#cb276-2"></a>maat.comparison &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">&#39;regular samples&#39;</span> =<span class="st"> </span>e<span class="op">$</span>MAAT,</span>
<span id="cb276-3"><a href="spatial-data-in-r.html#cb276-3"></a>                        <span class="st">&#39;polygon centroids&#39;</span> =<span class="st"> </span>e.pts<span class="op">$</span>MAAT)</span>
<span id="cb276-4"><a href="spatial-data-in-r.html#cb276-4"></a></span>
<span id="cb276-5"><a href="spatial-data-in-r.html#cb276-5"></a><span class="co"># number of samples per method</span></span>
<span id="cb276-6"><a href="spatial-data-in-r.html#cb276-6"></a><span class="kw">lapply</span>(maat.comparison, length)</span></code></pre></div>
<pre><code>## $`regular samples`
## [1] 86
## 
## $`polygon centroids`
## [1] 395</code></pre>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="spatial-data-in-r.html#cb278-1"></a><span class="co"># summary() applied by group</span></span>
<span id="cb278-2"><a href="spatial-data-in-r.html#cb278-2"></a><span class="kw">lapply</span>(maat.comparison, summary)</span></code></pre></div>
<pre><code>## $`regular samples`
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   16.52   16.60   16.65   16.65   16.68   17.05 
## 
## $`polygon centroids`
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   16.18   16.61   16.65   16.66   16.72   17.10</code></pre>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="spatial-data-in-r.html#cb280-1"></a><span class="co"># box-whisker plot</span></span>
<span id="cb280-2"><a href="spatial-data-in-r.html#cb280-2"></a><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="fl">4.5</span>, <span class="dv">8</span>, <span class="dv">3</span>, <span class="dv">1</span>), <span class="dt">mfcol =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb280-3"><a href="spatial-data-in-r.html#cb280-3"></a><span class="kw">boxplot</span>(</span>
<span id="cb280-4"><a href="spatial-data-in-r.html#cb280-4"></a>  maat.comparison,</span>
<span id="cb280-5"><a href="spatial-data-in-r.html#cb280-5"></a>  <span class="dt">horizontal =</span> <span class="ot">TRUE</span>,</span>
<span id="cb280-6"><a href="spatial-data-in-r.html#cb280-6"></a>  <span class="dt">las =</span> <span class="dv">1</span>,</span>
<span id="cb280-7"><a href="spatial-data-in-r.html#cb280-7"></a>  <span class="dt">xlab =</span> <span class="st">&#39;MAAT (deg C)&#39;</span>,</span>
<span id="cb280-8"><a href="spatial-data-in-r.html#cb280-8"></a>  <span class="dt">varwidth =</span> <span class="ot">TRUE</span>,</span>
<span id="cb280-9"><a href="spatial-data-in-r.html#cb280-9"></a>  <span class="dt">boxwex =</span> <span class="fl">0.5</span>,</span>
<span id="cb280-10"><a href="spatial-data-in-r.html#cb280-10"></a>  <span class="dt">main =</span> <span class="st">&#39;MAAT Comparison&#39;</span></span>
<span id="cb280-11"><a href="spatial-data-in-r.html#cb280-11"></a>)</span></code></pre></div>
<p><img src="newbook_files/figure-html/unnamed-chunk-155-1.png" width="576" /></p>
<p>Basic climate summaries from a standardized source (e.g. PRISM) might be a useful addition to an OSD.</p>
<p>Think about how you could adapt this example to compare climate summaries derived from NASIS pedons to similar summaries derived from map unit polygons and generalized soil series extents.</p>
</div>
<div id="raster-summary-by-polygon-mlra" class="section level4">
<h4><span class="header-section-number">4.6.5.4</span> Raster Summary By Polygon: MLRA</h4>
<p>The following example is a simplified version of what is available in the <a href="https://github.com/ncss-tech/soilReports"><code>soilReports</code></a> package, reports on the <a href="https://github.com/ncss-tech/soil-pit/tree/master/reports">ncss-tech</a> GitHub repository, or in the <a href="https://www.fs.fed.us/eng/rsac/programs/teui/about.html">TEUI suite of map unit summary tools</a>. The <a href="http://ncss-tech.github.io/AQP/sharpshootR/GIS-summary-by-MU.html"><em>Computing GIS Summaries from Map Unit Polygons</em></a> tutorial is an expanded version of this example.</p>
<p>Example output from the <code>soilReports</code> package:</p>
<ul>
<li><a href="http://ncss-tech.github.io/example-reports/mu-comparison/CA630-mu-comparison.html">summary of select CA630 map units</a></li>
<li><a href="http://ncss-tech.github.io/example-reports/mu-comparison/MLRA-comparison-report.html">summary of select MLRA polygons</a></li>
</ul>
<p>Efficient summary of large raster data sources can be accomplished using:</p>
<ul>
<li>internally-compressed raster data sources, stored on a local disk, can be in any coordinate system</li>
<li>polygons stored in an equal-area or UTM coordinate system, with CRS units of meters</li>
<li><a href="http://ncss-tech.github.io/AQP/sharpshootR/sample-vs-population.html">fixed-density sampling</a> of polygons</li>
<li>estimation of quantiles from collected raster samples</li>
</ul>
<p>Back to our example data. The first step is to check the MLRA polygons (<code>mlra</code>); how many features per MLRA symbol? Note that some MLRA have more than one polygon.</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="spatial-data-in-r.html#cb281-1"></a><span class="kw">table</span>(mlra<span class="op">$</span>MLRARSYM)</span></code></pre></div>
<p>Convert polygon area from square meters to acres and summarize. Note that this will only make sense when using a projected CRS with units of meters (equal area)!</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="spatial-data-in-r.html#cb282-1"></a>poly.area &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">sapply</span>(mlra<span class="op">@</span>polygons, slot, <span class="st">&#39;area&#39;</span>) <span class="op">*</span><span class="st"> </span><span class="fl">0.000247105</span>)</span>
<span id="cb282-2"><a href="spatial-data-in-r.html#cb282-2"></a><span class="kw">summary</span>(poly.area)</span>
<span id="cb282-3"><a href="spatial-data-in-r.html#cb282-3"></a><span class="kw">sum</span>(poly.area)</span></code></pre></div>
<p>Sample each polygon at a constant sampling density of <code>0.001</code> samples per acre (1 sample for every 1,000 ac.). At this sampling density we should expect approximately 16,700 samples–more than enough for our simple example.</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="spatial-data-in-r.html#cb283-1"></a><span class="kw">library</span>(sharpshootR)</span>
<span id="cb283-2"><a href="spatial-data-in-r.html#cb283-2"></a></span>
<span id="cb283-3"><a href="spatial-data-in-r.html#cb283-3"></a><span class="co"># the next function requires a polygon ID: </span></span>
<span id="cb283-4"><a href="spatial-data-in-r.html#cb283-4"></a><span class="co">#  each polygon gets a unique number 1--number of polygons</span></span>
<span id="cb283-5"><a href="spatial-data-in-r.html#cb283-5"></a>mlra<span class="op">$</span>pID &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(mlra)</span>
<span id="cb283-6"><a href="spatial-data-in-r.html#cb283-6"></a>s &lt;-<span class="st"> </span><span class="kw">constantDensitySampling</span>(mlra, <span class="dt">n.pts.per.ac =</span> <span class="fl">0.001</span>)</span></code></pre></div>
<p>Extract MLRA symbol at sample points using the <code>over()</code> function. The result will be a <code>data.frame</code> object with all attributes from our MLRA polygons that intersect sampling points <code>s</code>.</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="spatial-data-in-r.html#cb284-1"></a><span class="co"># spatial overlay: sampling points and MLRA polygons</span></span>
<span id="cb284-2"><a href="spatial-data-in-r.html#cb284-2"></a>res &lt;-<span class="st"> </span><span class="kw">over</span>(<span class="kw">spTransform</span>(s, <span class="kw">proj4string</span>(mlra)), mlra)</span>
<span id="cb284-3"><a href="spatial-data-in-r.html#cb284-3"></a></span>
<span id="cb284-4"><a href="spatial-data-in-r.html#cb284-4"></a><span class="co"># row / feature order is preserved, so we can directly copy</span></span>
<span id="cb284-5"><a href="spatial-data-in-r.html#cb284-5"></a>s<span class="op">$</span>mlra &lt;-<span class="st"> </span>res<span class="op">$</span>MLRARSYM</span>
<span id="cb284-6"><a href="spatial-data-in-r.html#cb284-6"></a></span>
<span id="cb284-7"><a href="spatial-data-in-r.html#cb284-7"></a><span class="co"># tabulate number of samples per MLRA</span></span>
<span id="cb284-8"><a href="spatial-data-in-r.html#cb284-8"></a><span class="kw">table</span>(s<span class="op">$</span>mlra)</span></code></pre></div>
<pre><code>## 
## 18 
## 76</code></pre>
<p>Extract values from the <code>RasterStack</code> of PRISM data as a <code>data.frame</code>.</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="spatial-data-in-r.html#cb286-1"></a><span class="co"># raster stack extraction at sampling points</span></span>
<span id="cb286-2"><a href="spatial-data-in-r.html#cb286-2"></a>e &lt;-<span class="st"> </span><span class="kw">extract</span>(rs, s, <span class="dt">df=</span><span class="ot">TRUE</span>)</span>
<span id="cb286-3"><a href="spatial-data-in-r.html#cb286-3"></a></span>
<span id="cb286-4"><a href="spatial-data-in-r.html#cb286-4"></a><span class="co"># convert sampling points from SpatialPointsDataFrame to data.frame</span></span>
<span id="cb286-5"><a href="spatial-data-in-r.html#cb286-5"></a>s.df &lt;-<span class="st"> </span><span class="kw">as</span>(s, <span class="st">&#39;data.frame&#39;</span>)</span>
<span id="cb286-6"><a href="spatial-data-in-r.html#cb286-6"></a></span>
<span id="cb286-7"><a href="spatial-data-in-r.html#cb286-7"></a><span class="co"># join columns from extracted values and sampling points</span></span>
<span id="cb286-8"><a href="spatial-data-in-r.html#cb286-8"></a>s.df &lt;-<span class="st"> </span><span class="kw">cbind</span>(s.df, e)</span>
<span id="cb286-9"><a href="spatial-data-in-r.html#cb286-9"></a></span>
<span id="cb286-10"><a href="spatial-data-in-r.html#cb286-10"></a><span class="co"># check results</span></span>
<span id="cb286-11"><a href="spatial-data-in-r.html#cb286-11"></a><span class="kw">head</span>(s.df)</span></code></pre></div>
<pre><code>##   mlra         x        y ID     MAAT MAP FFD  GDD rain.fraction   eff.PPT
## 1   18 -120.1130 37.22703  1 17.04607 344 312 2758            99 -557.8790
## 2 &lt;NA&gt; -120.2316 37.34116  2 16.83997 335 313 2712            99 -546.8068
## 3   18 -120.2712 37.36398  3 16.74595 331 314 2698            99 -544.6131
## 4   18 -120.2975 37.40963  4 16.71504 341 315 2682            99 -530.5748
## 5   18 -120.2843 37.43246  5 16.68312 360 315 2677            99 -509.5594
## 6   18 -120.2975 37.45528  6 16.81515 383 324 2695            99 -490.1275</code></pre>
<p>Summarizing multivariate data by group (MLRA) is usually much simpler after reshaping data from “wide” to “long” format.</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="spatial-data-in-r.html#cb288-1"></a><span class="kw">library</span>(reshape2)</span>
<span id="cb288-2"><a href="spatial-data-in-r.html#cb288-2"></a></span>
<span id="cb288-3"><a href="spatial-data-in-r.html#cb288-3"></a><span class="co"># reshape from wide to long format</span></span>
<span id="cb288-4"><a href="spatial-data-in-r.html#cb288-4"></a>m &lt;-<span class="st"> </span><span class="kw">melt</span>(s.df,</span>
<span id="cb288-5"><a href="spatial-data-in-r.html#cb288-5"></a>          <span class="dt">id.vars =</span> <span class="kw">c</span>(<span class="st">&#39;mlra&#39;</span>),</span>
<span id="cb288-6"><a href="spatial-data-in-r.html#cb288-6"></a>          <span class="dt">measure.vars =</span> <span class="kw">c</span>(<span class="st">&#39;MAAT&#39;</span>, <span class="st">&#39;MAP&#39;</span>, <span class="st">&#39;FFD&#39;</span>, <span class="st">&#39;GDD&#39;</span>, <span class="st">&#39;rain.fraction&#39;</span>, <span class="st">&#39;eff.PPT&#39;</span>))</span>
<span id="cb288-7"><a href="spatial-data-in-r.html#cb288-7"></a></span>
<span id="cb288-8"><a href="spatial-data-in-r.html#cb288-8"></a><span class="co"># check &quot;wide&quot; format</span></span>
<span id="cb288-9"><a href="spatial-data-in-r.html#cb288-9"></a><span class="kw">head</span>(m)</span></code></pre></div>
<pre><code>##   mlra variable    value
## 1   18     MAAT 17.04607
## 2 &lt;NA&gt;     MAAT 16.83997
## 3   18     MAAT 16.74595
## 4   18     MAAT 16.71504
## 5   18     MAAT 16.68312
## 6   18     MAAT 16.81515</code></pre>
<p>A simple tabular summary of means by MLRA and PRISM variable using <code>tapply()</code>.</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="spatial-data-in-r.html#cb290-1"></a><span class="co"># tabular summary of mean values</span></span>
<span id="cb290-2"><a href="spatial-data-in-r.html#cb290-2"></a><span class="kw">tapply</span>(m<span class="op">$</span>value, <span class="kw">list</span>(m<span class="op">$</span>mlra, m<span class="op">$</span>variable), mean)</span></code></pre></div>
<pre><code>##        MAAT      MAP      FFD      GDD rain.fraction   eff.PPT
## 18 16.65127 484.9868 329.3289 2642.579      99.01316 -362.7289</code></pre>
</div>
<div id="faster-with-exactextractr" class="section level4">
<h4><span class="header-section-number">4.6.5.5</span> Faster with <code>exactextractr</code></h4>
<p>This example shows how to determine the distribution of Frost-Free Days across a soil series extent.</p>
<p>The data are extracted from the raster data source very rapidly using the <code>exactextractr</code> package.</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="spatial-data-in-r.html#cb292-1"></a><span class="kw">library</span>(sf)</span>
<span id="cb292-2"><a href="spatial-data-in-r.html#cb292-2"></a><span class="kw">library</span>(soilDB)</span>
<span id="cb292-3"><a href="spatial-data-in-r.html#cb292-3"></a><span class="kw">library</span>(raster)</span>
<span id="cb292-4"><a href="spatial-data-in-r.html#cb292-4"></a><span class="kw">library</span>(lattice)</span>
<span id="cb292-5"><a href="spatial-data-in-r.html#cb292-5"></a><span class="kw">library</span>(exactextractr)</span>
<span id="cb292-6"><a href="spatial-data-in-r.html#cb292-6"></a></span>
<span id="cb292-7"><a href="spatial-data-in-r.html#cb292-7"></a><span class="co"># 5-10 seconds to download Series Extent Explorer data </span></span>
<span id="cb292-8"><a href="spatial-data-in-r.html#cb292-8"></a>series &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;holland&#39;</span>,<span class="st">&#39;san joaquin&#39;</span>)</span>
<span id="cb292-9"><a href="spatial-data-in-r.html#cb292-9"></a></span>
<span id="cb292-10"><a href="spatial-data-in-r.html#cb292-10"></a><span class="co"># make SpatialPolygonsDataFrame</span></span>
<span id="cb292-11"><a href="spatial-data-in-r.html#cb292-11"></a>s &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&#39;rbind&#39;</span>, <span class="kw">lapply</span>(series, seriesExtent))</span>
<span id="cb292-12"><a href="spatial-data-in-r.html#cb292-12"></a></span>
<span id="cb292-13"><a href="spatial-data-in-r.html#cb292-13"></a><span class="co"># load pointer to PRISM data</span></span>
<span id="cb292-14"><a href="spatial-data-in-r.html#cb292-14"></a>r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&#39;C:/workspace2/chapter-2b/FFD.tif&#39;</span>)</span>
<span id="cb292-15"><a href="spatial-data-in-r.html#cb292-15"></a></span>
<span id="cb292-16"><a href="spatial-data-in-r.html#cb292-16"></a><span class="co"># transform extent to CRS of raster with sf</span></span>
<span id="cb292-17"><a href="spatial-data-in-r.html#cb292-17"></a>s &lt;-<span class="st"> </span><span class="kw">st_transform</span>(<span class="kw">st_as_sf</span>(s), <span class="dt">crs =</span> <span class="kw">st_crs</span>(r))</span>
<span id="cb292-18"><a href="spatial-data-in-r.html#cb292-18"></a></span>
<span id="cb292-19"><a href="spatial-data-in-r.html#cb292-19"></a><span class="co"># inspect</span></span>
<span id="cb292-20"><a href="spatial-data-in-r.html#cb292-20"></a>s</span>
<span id="cb292-21"><a href="spatial-data-in-r.html#cb292-21"></a></span>
<span id="cb292-22"><a href="spatial-data-in-r.html#cb292-22"></a><span class="co"># use `st_union(s)` to create a MULTI- POINT/LINE/POLYGON from single</span></span>
<span id="cb292-23"><a href="spatial-data-in-r.html#cb292-23"></a><span class="co"># use `sf::st_cast(s, &#39;POLYGON&#39;)` to create other types</span></span>
<span id="cb292-24"><a href="spatial-data-in-r.html#cb292-24"></a></span>
<span id="cb292-25"><a href="spatial-data-in-r.html#cb292-25"></a><span class="co"># &lt;0.4 seconds for sampling, including coverage fractions!</span></span>
<span id="cb292-26"><a href="spatial-data-in-r.html#cb292-26"></a><span class="kw">system.time</span>({ ex &lt;-<span class="st"> </span>exactextractr<span class="op">::</span><span class="kw">exact_extract</span>(r, s) })</span>
<span id="cb292-27"><a href="spatial-data-in-r.html#cb292-27"></a></span>
<span id="cb292-28"><a href="spatial-data-in-r.html#cb292-28"></a><span class="co"># ex is a list(), with data.frame [value, coverage_fraction]</span></span>
<span id="cb292-29"><a href="spatial-data-in-r.html#cb292-29"></a><span class="co">#  for each polygon in s (we have one MULTIPOLYGON per series)</span></span>
<span id="cb292-30"><a href="spatial-data-in-r.html#cb292-30"></a></span>
<span id="cb292-31"><a href="spatial-data-in-r.html#cb292-31"></a><span class="co"># combine all list elements `ex` into single data.frame `ex.all`</span></span>
<span id="cb292-32"><a href="spatial-data-in-r.html#cb292-32"></a><span class="co">#  - use do.call(&#39;rbind&#39;, ...) to stack data.frames row-wise</span></span>
<span id="cb292-33"><a href="spatial-data-in-r.html#cb292-33"></a><span class="co">#  - an anonymous function that iterates along length of `ex`</span></span>
<span id="cb292-34"><a href="spatial-data-in-r.html#cb292-34"></a><span class="co">#  - adding the series name to as a new variable, calculated using `i`</span></span>
<span id="cb292-35"><a href="spatial-data-in-r.html#cb292-35"></a>ex.all &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&#39;rbind&#39;</span>, <span class="kw">lapply</span>(<span class="kw">seq_along</span>(ex), <span class="cf">function</span>(i) {</span>
<span id="cb292-36"><a href="spatial-data-in-r.html#cb292-36"></a>  <span class="kw">cbind</span>(<span class="kw">data.frame</span>(<span class="dt">group =</span> series[i]), ex[[i]])</span>
<span id="cb292-37"><a href="spatial-data-in-r.html#cb292-37"></a>}))</span>
<span id="cb292-38"><a href="spatial-data-in-r.html#cb292-38"></a></span>
<span id="cb292-39"><a href="spatial-data-in-r.html#cb292-39"></a><span class="co"># simple summary</span></span>
<span id="cb292-40"><a href="spatial-data-in-r.html#cb292-40"></a><span class="kw">densityplot</span>(<span class="op">~</span><span class="st"> </span>value <span class="op">|</span><span class="st"> </span>group, <span class="dt">data =</span> ex.all, </span>
<span id="cb292-41"><a href="spatial-data-in-r.html#cb292-41"></a>            <span class="dt">plot.points=</span><span class="ot">FALSE</span>, <span class="dt">bw =</span> <span class="dv">2</span>, <span class="dt">lwd =</span> <span class="dv">2</span>,</span>
<span id="cb292-42"><a href="spatial-data-in-r.html#cb292-42"></a>            <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&#39;RoyalBlue&#39;</span>), <span class="dt">layout =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb292-43"><a href="spatial-data-in-r.html#cb292-43"></a>            <span class="dt">ylab =</span> <span class="st">&#39;Density&#39;</span>, <span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">400</span>,</span>
<span id="cb292-44"><a href="spatial-data-in-r.html#cb292-44"></a>            <span class="dt">xlab =</span> <span class="st">&#39;Frost-Free Days (50% chance)</span><span class="ch">\n</span><span class="st">800m PRISM Data (1981-2010)&#39;</span>, </span>
<span id="cb292-45"><a href="spatial-data-in-r.html#cb292-45"></a>            <span class="dt">main =</span> <span class="st">&#39;FFD Estimate for Extent of San Joaquin and Holland Series&#39;</span>)</span></code></pre></div>
<p><img src="newbook_files/figure-html/unnamed-chunk-163-1.png" width="576" />
<!--

I tried to give these examples a second chance but they are not that useful in current form.

### More Spatial Exploratory Data Analysis

##### `lattice` graphics

Lattice graphics are useful for summarizing grouped comparisons. 

The syntax is difficult to learn and remember, but there is a lot of [documentation online](http://www.statmethods.net/advgraphs/trellis.html). 


```r
library(lattice)

tps <- list(
    box.rectangle = list(col = 'black'),
    box.umbrella = list(col = 'black', lty = 1),
    box.dot = list(cex = 0.75),
    plot.symbol = list(
      col = rgb(0.1, 0.1, 0.1, alpha = 0.25, maxColorValue = 1),
      cex = 0.25
    )
  )

bwplot(mlra ~ value | variable, data=m,                 # setup plot and data source
       as.table=TRUE,                                   # start panels in top/left corner
       varwidth=TRUE,                                   # scale width of box by number of obs
       scales=list(alternating=3, relation='free'),     # setup scales
       strip=strip.custom(bg=grey(0.9)),                # styling for strips
       par.settings=tps,                                # apply box/line/point styling
       panel=function(...) {                            # within in panel, do the following
          panel.grid(-1, -1)                            # make grid lines at all tick marks
          panel.bwplot(...)                             # make box-whisker plot
      }
)
```

<img src="newbook_files/figure-html/unnamed-chunk-164-1.png" width="768" />

##### Interactive Summaries

Static figures are a good start, but sometimes an interactive summary is more appropriate for EDA.

The `histboxp` function from the `Hmisc` package creates interactive (HTML) chunks that can be used in RStudio, or embedded in RMarkdown documents (e.g. these notes or `soilReports`). Use the mouse to hover over, click, drag, etc. to interact with the data. Double-click to reset the plot.


```r
library(Hmisc)

# interactive exploration of the MAAT distributions by MLRA
histboxp(
  x = s.df$MAAT,
  group = s.df$mlra,
  bins = 100,
  xlab = 'Mean Annual Air Temperature (deg C)'
)

# interactive exploration of the Effective PPT distributions by MLRA
histboxp(
  x = s.df$eff.PPT,
  group = s.df$mlra,
  bins = 100,
  xlab = 'Annual Sum of Monthly PPT - PET (mm)'
)
```
--></p>
</div>
</div>
</div>
<div id="additional-reading-spatial" class="section level2">
<h2><span class="header-section-number">4.7</span> Additional Reading (Spatial)</h2>
<ul>
<li><p>Ahmed, Zia. 2020. <a href="https://zia207.github.io/geospatial-r-github.io/index.html">Geospatial Data Science with R</a>.</p></li>
<li><p>Gimond, M., 2019. Intro to GIS and Spatial Analysis <a href="https://mgimond.github.io/Spatial/">https://mgimond.github.io/Spatial/</a></p></li>
<li><p>Hijmans, R.J. 2019. Spatial Data Science with R. <a href="https://rspatial.org/">https://rspatial.org/</a></p></li>
<li><p>Lovelace, R., J. Nowosad, and J. Muenchow, 2019. Geocomputation with R. CRC Press. <a href="https://bookdown.org/robinlovelace/geocompr/">https://bookdown.org/robinlovelace/geocompr/</a></p></li>
<li><p>Pebesma, E., and R.S. Bivand. 2005. Classes and methods for spatial data: The sp package. <a href="https://cran.r-project.org/web/packages/sp/vignettes/intro_sp.pdf">https://cran.r-project.org/web/packages/sp/vignettes/intro_sp.pdf</a>.</p></li>
<li><p>Pebesma, E. and R. Bivand, 2019. Spatial Data Science. <a href="https://keen-swartz-3146c4.netlify.com/">https://keen-swartz-3146c4.netlify.com/</a></p></li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="exploratory-data-analysis.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sampling.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["newbook.pdf", "newbook.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
